<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>跋桮啦！ Poa̍h-poe--lah!</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/icons/icon-192.png">
  <meta name="theme-color" content="#0b0b0f">
  <style>
  /* ========================
   *  Base variables & layout
   * ======================== */
  :root{
    --bg:#0b0b0f; --fg:#f2f4f8; --muted:#b9bcc6; --acc:#ffd452;
    --card:#141822; --glass:rgba(255,255,255,.06);

    --ok:#4caf50; --bad:#ef5350; --meh:#ffb020;

    /* === Result layout (single source of truth) === */
    --result-lift:120px;     /* 結果區整塊往上貼近祈禱文的距離 */
    --res-h2-top:.8em;       /* 「指示結果」上方距離（大約 2 行內） */
    --res-h2-bottom:1.2em;   /* 「指示結果」與杯圖距離（≈ 2 行） */
    --res-dice-bottom:1.6em; /* 杯圖與下方文字距離 */
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; color:var(--fg); background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  }
  main{ max-width:680px; margin:0 auto; padding:16px 16px 72px; }

  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,#0b0b0f 70%,#0b0b0f00);
    padding:12px 16px; display:flex; gap:8px; align-items:center;
  }
  h1{ font-size:22px; margin:0 8px 0 0; }
  .lang{ margin-left:auto; }

  /* 確保 hidden 真的隱形、不可聚焦、從無障礙樹移除 */
  [hidden]{ display:none !important; }

  /* =========
   *  Controls
   * ========= */
  select,input,textarea,button{
    width:100%; padding:9px 10px; font-size:16px; border-radius:10px;
    color:var(--fg);
    background:rgba(15,19,32,.55);
    border:1px solid rgba(32,36,55,.6);
    -webkit-backdrop-filter:blur(4px); backdrop-filter:blur(4px);
  }
  textarea{ min-height:70px; resize:vertical }

  /* Glass blocks */
  fieldset,.card,.prayer{
    background:rgba(15,20,34,.55);
    border:1px solid rgba(31,36,53,.7);
    -webkit-backdrop-filter:blur(4px); backdrop-filter:blur(4px);
  }
  legend{ padding:0 8px; color:#d6daea; }
  .row{ display:grid; grid-template-columns:1fr; gap:12px; }

  /* =====
   * Cards
   * ===== */
  .cards{
    display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
  }
  .card{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    border-radius:16px; padding:10px; cursor:pointer; outline:none;
    -webkit-backdrop-filter:blur(5px) saturate(130%); backdrop-filter:blur(5px) saturate(130%);
    transition:all .25s ease;
  }
  .card[aria-pressed="true"], .card:focus{
    box-shadow:0 0 0 2px var(--acc) inset; background:rgba(255,255,255,.12);
  }
  .thumb{ background:rgba(255,255,255,.12); border-radius:12px; -webkit-backdrop-filter:blur(3px); backdrop-filter:blur(3px); }
  .cards .label{ display:block; text-align:center; margin-top:6px; font-size:14px; color:#f2f4f8; text-shadow:0 1px 2px rgba(0,0,0,.4); }

  /* =======
   * Toolbar
   * ======= */
  .toolbar{
    position:fixed; left:0; right:0; bottom:0;
    background:linear-gradient(180deg,transparent,rgba(0,0,0,.25)),#0b0b0f;
    padding:12px 16px; display:flex; gap:12px; z-index:20;
  }
  .btn{ background:#1a2140; border:1px solid #232a52; color:#fff; padding:12px 14px; border-radius:14px; font-size:18px; }
  .btn.primary{ background:linear-gradient(180deg,#2a3568,#1f2852); border-color:#3b4aa8; }
  .btn.ghost{ background:#0f1320; }

  /* =========
   * Content UI
   * ========= */
  .center{ display:grid; place-items:center; }
  .prayer{ line-height:1.7; color:#dfe3f3; border-style:dashed; border-radius:16px; padding:14px; }
  .result{ display:grid; gap:12px; }

  /* ========
   * Dice/Cup
   * ======== */
  .dice{ display:flex; justify-content:center; gap:28px; margin:8px 0 16px; }
  .cup{
    position:relative; overflow:visible;
    width:clamp(96px,30vw,140px); height:clamp(96px,30vw,140px);
    display:grid; place-items:center;
  }
  .cup img,.cup svg{
    max-width:85%; max-height:85%; width:auto; height:auto; object-fit:contain;
  }

  /* Animations */
  .float{ animation:float 2s ease-in-out infinite; }
  @keyframes float{ 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }
  .toss{ animation:toss .9s cubic-bezier(.2,.8,.2,1); }
  @keyframes toss{ 0%{transform:translateY(-20vh) rotate(-40deg); opacity:.7} 60%{transform:translateY(0) rotate(0)} 80%{transform:translateY(-5px)} 100%{transform:translateY(0); opacity:1} }
  .bounce{ animation:bounceStrong .8s cubic-bezier(.25,.65,.35,1.3); }
  @keyframes bounceStrong{ 0%{transform:translateY(0)} 20%{transform:translateY(20px)} 40%{transform:translateY(-24px)} 55%{transform:translateY(12px)} 70%{transform:translateY(-10px)} 85%{transform:translateY(4px)} 100%{transform:translateY(0)} }
  .sway{ animation:swayFew 1.1s ease-in-out forwards; }
  @keyframes swayFew{ 0%{rotate:0} 10%{rotate:-10deg} 25%{rotate:10deg} 40%{rotate:-8deg} 60%{rotate:8deg} 80%{rotate:-4deg} 100%{rotate:0} }
  @media (prefers-reduced-motion:reduce){ .sway,.shake,.toss{ animation:none!important; } }

  /* =====
   * Badge
   * ===== */
  .badge{
    display:inline-block; padding:.25rem .5rem; border-radius:999px; font-size:16px;
    border:1px solid #2a3152; background:#101424; color:#ccd2ea; margin-top:2em;
  }
  .ok{ color:#e8ffe8; border-color:#2f6b3a; background:rgba(76,175,80,.5); }
  .bad{ color:#ffecec; border-color:#7b3434; background:rgba(239,83,80,.5); }
  .meh{ color:#fff2e0; border-color:#7b5a24; background:rgba(255,176,32,.5); }

  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  .small{ font-size:12px; color:#aeb6d8; }

  /* =======================
   * Result page (unified!)
   * ======================= */
  #page-result h2{ margin: var(--res-h2-top) 0 var(--res-h2-bottom) !important; }
  #page-result .dice{ margin: 0 0 var(--res-dice-bottom) !important; }
  #resLines{ background:rgba(0,0,0,.4); border-radius:14px; padding:10px 12px; }
  #resLines b{ font-weight:600; color:#fff9cc; }

  /* 發光：依結果變色 */
  .glow{ position:relative; z-index:1; }
  .glow::after{
    content:""; position:absolute; inset:-40px; border-radius:50%;
    background:radial-gradient(circle, rgba(255,223,100,.55) 0%, rgba(255,223,100,.35) 25%, rgba(255,223,100,.15) 50%, rgba(255,223,100,0) 80%);
    filter:blur(12px); opacity:0; animation:glowTwice 1.4s ease-in-out;
  }
  @keyframes glowTwice{ 0%,100%{opacity:0; transform:scale(1)} 20%{opacity:.9; transform:scale(1.1)} 35%{opacity:0} 55%{opacity:.8; transform:scale(1.15)} 70%{opacity:0} }
  .glow[data-outcome="bad"]::after{ background:radial-gradient(circle, rgba(180,180,180,.5) 0%, rgba(160,160,160,.3) 25%, rgba(130,130,130,.1) 50%, rgba(0,0,0,0) 80%); }
  .glow[data-outcome="meh"]::after{ background:radial-gradient(circle, rgba(255,170,50,.55) 0%, rgba(255,140,30,.35) 25%, rgba(255,110,0,.15) 50%, rgba(255,100,0,0) 80%); }

  /* 顯示結果時把整塊往上貼近祈禱文 */
  body.is-result #page-result{ margin-top:calc(-1 * var(--result-lift)); }
  body.is-result main{ padding-top:4px; }

  /* 只保留彩蛋條，其他常駐說明隱藏 */
  #resLines > div:not(.small){ display:none; }
  body.is-result #resLines .small{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:calc(72px + 12px);
    width:min(92vw,680px); z-index:15;
    text-align:left; font-size:14px; color:#f6f8ff;
    background:rgba(0,0,0,.55); border-radius:12px; padding:8px 12px;
    box-shadow:0 6px 24px rgba(0,0,0,.25);
  }
  #resLines .small{ opacity:0; transition:opacity .2s ease; }
  #resLines .small.show{ opacity:1; }

  /* 讓結果圖容器穩定置中與尺寸 */
  #page-result .cup{ display:grid; place-items:center; width:clamp(96px,30vw,140px); height:clamp(96px,30vw,140px); }
  #page-result .cup img,#page-result .cup svg{ max-width:90%; max-height:90%; width:auto; height:auto; display:block; object-fit:contain; }

  /* ========
   * Accordeon
   * ======== */
  fieldset.fold{ overflow:hidden; padding:0; }
  fieldset.fold > legend{
    display:flex; align-items:center; gap:8px;
    padding:12px; margin:0; cursor:pointer; user-select:none;
    border-bottom:1px solid #1f2435;
  }
  fieldset.fold > legend .legend-text{ flex:1; color:#d6daea; font-weight:600; }
  fieldset.fold > legend .caret{ width:10px; height:10px; transform:rotate(0); border-right:2px solid #cfd3e6; border-bottom:2px solid #cfd3e6; margin-left:6px; transition:transform .18s ease; }
  fieldset.fold[aria-expanded="true"] > legend .caret{ transform:rotate(45deg); }
  fieldset.fold[aria-expanded="false"] > legend .caret{ transform:rotate(-135deg); }
  .fold-content{
    padding:10px 12px 12px; display:grid; gap:12px; max-height:0; overflow:hidden; transition:max-height .22s ease;
    background:rgba(255,255,255,.04); -webkit-backdrop-filter:blur(9px) saturate(150%); backdrop-filter:blur(9px) saturate(150%);
    border-top:1px solid rgba(255,255,255,.25); border-bottom:1px solid rgba(255,255,255,.12); box-shadow:0 2px 12px rgba(0,0,0,.1);
  }
  .fold-content label,.fold-content span[data-i],.fold-content input,.fold-content textarea{ font-size:17px; line-height:1.6; }
  .fold-content .small{ font-size:14px; color:#e6e9f5; }
  fieldset.fold[aria-expanded="true"] > .fold-content{ max-height:800px; }

  /* ======
   * Header
   * ====== */
  .bgm select{
    padding:6px 10px; font-size:14px; border-radius:10px; margin-left:8px;
    background:#0f1320; color:#f2f4f8; border:1px solid #202437;
  }

  /* =========
   * Background
   * ========= */
  body::before{
    content:""; position:fixed; inset:0;
    background:url("assets/images/bg.webp") center/cover no-repeat fixed;
    opacity:1; filter:none; z-index:-1;
  }

  /* =================
   * Mobile adjustments
   * ================= */
  @media (max-width:480px),(max-height:740px){
    body,main{ font-size:15px; line-height:1.45; }
    main{ padding:8px 12px 72px; max-width:560px; }

    header{ padding:8px 10px; }
    h1{ font-size:18px; margin-right:6px; }

    fieldset{ padding:10px; border-radius:12px; }
    legend{ font-size:15px; margin-bottom:4px; }
    label{ font-size:14px; }

    .row{ gap:10px; }
    .cards{ gap:8px; }
    .card{ padding:8px; border-radius:10px; }
    .thumb{ border-radius:8px; }
    .cards .label{ font-size:11.5px; margin-top:3px; }

    .toolbar{ padding:8px 10px; gap:6px; }
    .btn{ padding:10px 12px; font-size:16px; border-radius:12px; }

    /* Pray page brief */
    #page-pray h2{ margin:0 0 4px; font-size:16px; font-weight:600; opacity:.9; }
    #page-pray .prayer{
      font-size:14px; padding:10px; margin:0 0 6px; line-height:1.5;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    #page-pray .dice{ gap:14px; margin:4px 0 8px; }

    /* 用「調變數」來控制結果頁間距（規則不重寫） */
    :root{
      --result-lift:132px;
      --res-h2-top:.7em;
      --res-h2-bottom:1.1em;
      --res-dice-bottom:1.4em;
    }
  }
    /* ===== Step 1: 設定頁輸入標題強化（黃色 + 放大） ===== */

  /* fieldset 標題（例如 求問對象、選擇桮款式） */
  #setupForm > fieldset > legend,
  #setupForm > fieldset > legend .legend-text {
    color: var(--acc);          /* 使用你的主題黃色 */
    font-size: 22px;            /* 放大字體 */
    font-weight: 800;
    text-align: center;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.25);
  }

  /* 單獨輸入項目標題（例如 求問者姓名／暱稱、求問事項） */
  #setupForm > label > span[data-i] {
    display: block;
    color: var(--acc);
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    margin: 8px 0 10px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.25);
  }

  /* 手機微調 */
  @media (max-width:480px) {
    #setupForm > fieldset > legend,
    #setupForm > fieldset > legend .legend-text {
      font-size: 20px;
    }
    #setupForm > label > span[data-i] {
      font-size: 18px;
      margin: 6px 0 8px;
    }
  }
  /* ===== 祈禱頁：神聖漂浮＋光暈特效 ===== */
  #page-pray .cup {
    position: relative;
    transform: scale(1.28);                 /* 放大 */
    transition: transform .3s ease;
    z-index: 0;                             /* 給 halo 疊層用 */
  }

  /* 圖像微擺頭（更有活著的感覺） */
  #page-pray .cup img,
  #page-pray .cup svg {
    animation:
      holyYaw 6s ease-in-out infinite,
      holyBreath 5.5s ease-in-out infinite;
    filter:
      drop-shadow(0 10px 14px rgba(0,0,0,.45))
      drop-shadow(0 0 10px rgba(255,212,82,.22));
    will-change: transform, filter;
  }

  /* 金色光暈（脈動兩層） */
  #page-pray .cup::after {
    content: "";
    position: absolute;
    inset: -32%;
    border-radius: 50%;
    pointer-events: none;
    background:
      radial-gradient(circle,
        rgba(255,223,120,.55) 0%,
        rgba(255,223,120,.25) 35%,
        rgba(255,223,120,.10) 58%,
        rgba(255,223,120,0) 75%);
    filter: blur(10px);
    animation: haloPulse 3.2s ease-in-out infinite;
    z-index: -1; /* 在桮後面 */
  }

  /* 手機略縮，避免超框 */
  @media (max-width:480px){
    #page-pray .cup { transform: scale(1.18); }
  }

  /* 動畫定義：微擺頭、輕呼吸、光暈脈動 */
  @keyframes holyYaw {
    0%   { transform: rotateZ(-2deg) }
    50%  { transform: rotateZ( 2deg) }
    100% { transform: rotateZ(-2deg) }
  }
  @keyframes holyBreath {
    0%,100% { transform: scale(1) }
    50%     { transform: scale(1.02) }
  }
  @keyframes haloPulse {
    0%,100% { opacity:.55; transform: scale(1) }
    40%     { opacity:.85; transform: scale(1.06) }
    70%     { opacity:.35; transform: scale(1.12) }
  }

  /* 使用者偏好「減少動態」：只留柔和陰影 */
  @media (prefers-reduced-motion: reduce){
    #page-pray .cup img,
    #page-pray .cup svg { animation: none !important; }
    #page-pray .cup::after { animation: none !important; opacity: .5; }
  }
  /* === 結果頁對齊修正：置中顯示，不再上提過頭 === */
  body.is-result #page-result{
    margin-top: 0 !important;            /* 取消原先的負上提 */
    min-height: calc(100svh - 152px);    /* 視窗高 - (header+toolbar) 的估值 */
    display: grid;
    align-content: center;               /* 垂直置中內容 */
  }

  /* 結果頁的兩顆杯圖：水平置中，保留你原本的下方間距變數 */
  #page-result .dice{
    justify-content: center;
    margin: 0 0 var(--res-dice-bottom) !important;
  }
  #btnToss {
    background: radial-gradient(circle at 50% 35%, #ff6666 0%, #cc0000 70%, #660000 100%);
    border: 2px solid #ffaaaa;
    color: #fffdf5;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0,0,0,.4);
    box-shadow:
      0 0 12px rgba(255,80,80,0.6),
      0 0 30px rgba(255,50,50,0.3);
    transition: all .2s ease-in-out;
  }
  #btnToss:hover {
    transform: scale(1.05);
    box-shadow:
      0 0 18px rgba(255,120,120,0.75),
      0 0 40px rgba(255,60,60,0.45);
  }
  #btnToss:active {
    transform: scale(0.97);
    background: radial-gradient(circle at 50% 35%, #dd3333 0%, #aa0000 70%, #550000 100%);
  }
  /* === 結果頁淡入動畫 === */
  #page-result {
    opacity: 0;
    transition: opacity 0.8s ease;   /* 淡入速度 */
  }

  #page-result.show {
    opacity: 1;
  }
  </style>

</head>
<body>
  <header>
    <h1 id="appTitle">跋桮啦！(Poa̍h-poe--lah!)</h1>
    <div class="lang">
      <label class="sr-only" for="langSel">語言</label>
      <select id="langSel" aria-label="語言">
        <option value="tl">台語</option>
        <option value="en">English</option>
        <option value="zh">華語</option>
      </select>
    </div>
    <div class="bgm">
  <label class="sr-only" for="bgmSel">背景音樂</label>
    <select id="bgmSel" aria-label="背景音樂">
      <option value="bg_01" selected>聖樂の音</option>
      <option value="bg_02">風鈴の音</option>
      <option value="bg_03">海洋の音</option>
      <option value="bg_04">自然の音</option>
    </select>
  </div>
  </header>
  <main>
  <!-- ===== Step 1. 求問設定 ===== -->
  <section id="page-setup1" aria-labelledby="setupTitle">
    <h2 id="setupTitle" class="sr-only">設定</h2>
    <div class="row" id="setupForm">
      <fieldset>
        <legend data-i="askWhoLegend">求問對象</legend>
        <div class="row">
          <label><input type="radio" name="who" value="god" checked> <span data-i="whoGod">某尊神明（輸入神明稱號）</span></label>
          <input id="whoName" type="text" placeholder="媽祖／關聖帝君／耶穌…" aria-describedby="whoHelp" />
          <label><input type="radio" name="who" value="ancestor"> <span data-i="whoAnc">某位祖先（或過世親人）</span></label>
          <input id="ancName" type="text" placeholder="阿公／阿嬤／阿祖…" />
          <label><input type="radio" name="who" value="universe"> <span data-i="whoUni">向宇宙天地冥冥之中力量求問</span></label>
        </div>
      </fieldset>

      <label>
        <span data-i="yourName">求問者姓名／暱稱</span>
        <input id="player" type="text" placeholder="輸入你的名字／暱稱" />
      </label>

      <label>
        <span data-i="wish">求問事項</span>
        <textarea id="wish"></textarea>
      </label>
    </div>
  </section>

  <!-- ===== Step 2. 選擇桮款式 ===== -->
  <section id="page-setup2" aria-labelledby="cupTitle" hidden>
    <h2 id="cupTitle">選擇桮款式</h2>
    <div id="cupList" class="cards" role="listbox" aria-label="杯款式"></div>
    <div class="small" data-i="cupHint">🔔 小提醒：無仝款式只是外形，靈驗度無差喔～</div>
  </section>


    <!-- ===== Step 3. 祈禱頁 ===== -->
    <section id="page-pray" hidden aria-labelledby="prayTitle" class="center">
      <div style="width:100%">
        <h2 id="prayTitle" data-i="prayTitle">先誠心祈禱，再跋桮</h2>
        <p class="prayer" id="prayText"></p>
        <div class="dice">
          <div class="cup float" id="previewL"></div>
          <div class="cup float" id="previewR"></div>
        </div>
      </div>
    </section>

    <!-- ===== Step 4. 結果頁 ===== -->
    <section id="page-result" hidden aria-labelledby="resTitle">
      <h2 id="resTitle" data-i="resTitle">指示結果</h2>
      <div class="dice">
        <div class="cup" id="resL"></div>
        <div class="cup" id="resR"></div>
      </div>
      <div class="result">
        <div><span class="badge" id="badge"></span></div>
        <div id="resLines"></div>
      </div>
    </section>
  </main>

  <div class="toolbar" role="group" aria-label="操作">
    <button class="btn ghost" id="btnBack" data-i="back">回設定</button>
    <button class="btn" id="btnNext" data-i="next">下一步</button>
    <button class="btn primary" id="btnToss" data-i="toss" hidden>跋桮 / poa̍h-poe</button>
    <button class="btn" id="btnAgain" data-i="again" hidden>再跋一擺</button>
    <button class="btn ghost" id="btnMute">背景音效🔈</button>
  </div>

  <template id="tpl-line"><div class="small"></div></template>

  <!-- 主邏輯：使用 ES Modules，直接 import CUPS -->
  <script type="module">
    import { CUPS as REG_CUPS } from './js/cups/registry.js';

    // ===== helpers =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // ===== i18n 初始語言（先算出 lang，再建立 S）=====
    let initialLang = localStorage.getItem('lang');
    if (!initialLang) {
      const sys = (navigator.language || 'zh').toLowerCase();
      if (sys.startsWith('en')) initialLang = 'en';
      else if (sys.startsWith('zh') || sys.startsWith('cmn')) initialLang = 'zh';
      else if (sys.includes('nan') || sys.includes('hak') || sys.includes('tw')) initialLang = 'tl';
      else initialLang = 'zh';
      localStorage.setItem('lang', initialLang);
    }

    // ===== state（只保留這一組）=====
    const CUPS = REG_CUPS;
    if (!CUPS || !CUPS.length) {
      console.error('CUPS 載入失敗：請檢查 js/cups/manifest.js / registry.js');
    }
    const S = { lang: initialLang, cup: CUPS?.[0]?.id || '', whoType: 'god' };

    // 🔸 提早宣告，避免 applyI18N() 首次執行時取不到
    let lastOutcome = null;

    // ===== i18n =====
    const I18N = {
      zh: {
        askWhoLegend:"求問對象", whoGod:"某尊神明（輸入神明稱號）", whoAnc:"某位祖先（含過世親人）", whoUni:"向宇宙天地冥冥之中力量求問",
        whoHelp:"輸入神明稱號，或改選其他對象", yourName:"求問者姓名／暱稱", wish:"求問事項",
        cupLegend:"❤️ 按下選筊", cupHint:"小提醒：不同樣式只是外觀，機率一樣啦～",
        prayTitle:"先誠心祈禱，再擲筊", resTitle:"指示結果",
        muteAllOn:  "🔇全部靜音",
        muteAllOff: "🔈開啟聲音",
        back:"回設定", next:"下一步", toss:"擲筊", again:"再擲一次",
        ok:"聖杯：得到應允，去做就對了！",
        bad:"陰杯：神明說不行，換個方法吧。",
        meh:"笑杯：神明／先人／神秘力量笑了，可能還沒旨意，或是沒聽懂你的意思，請再問一次。",
        who:"求問對象", you:"求問者", topic:"事項",
        streak: {
          meh: '❓❓❓ 連續三擺「笑杯」，建議：<b>自己做主！😆</b>',
          bad: '🚫🚫🚫 連續三擺「陰杯」，建議：<b>真的不行喔！❌</b>',
          ok:  '🎉🎉🎉 連續三擺「聖杯」，建議：<b>去做就對！😍</b>'
        }
      },
      tl: {
        askWhoLegend:"求問對象", whoGod:"某尊神明（輸入神明稱號）", whoAnc:"某mí祖先（包括過身親人）", whoUni:"Ǹg宇宙天地冥冥之中力量求問",
        whoHelp:"輸入神明稱號，或改選其他對象", yourName:"求問者姓名／暱稱", wish:"求問事項",
        cupLegend:"❤️ 揤遮選桮", cupHint:"提示：款式仝款，機率袂變～",
        prayTitle:"誠心祈求了後，揤落去跋桮", resTitle:"指示結果",
        muteAllOn:  "🔇全部靜音",
        muteAllOff: "🔈放送聲音",
        back:"倒轉--去", next:"後一步", toss:"跋桮 / poa̍h-poe", again:"閣跋一擺",
        ok:"神桮（sîn-poe / siūⁿ-poe）：得著應允，你ê祈求會實現！",
        bad:"陰桮（im-poe / bô-poe）：毋通喔，換一款做法。",
        meh:"笑桮（chhiò-poe）：神明／先人／神秘力量笑笑leh，可能猶未有旨意，抑是聽無你ê意思。",
        who:"求問對象", you:"祈求者", topic:"求啥代誌",
        streak: {
          meh: '❓❓❓ 連續三擺「笑桮」，建議：<b>家己決定啦！😆</b>',
          bad: '🚫🚫🚫 連續三擺「陰桮」，建議：<b>真正毋通喔！❌</b>',
          ok:  '🎉🎉🎉 連續三擺「神桮」，建議：<b>做就著啦！😍</b>'
        }
      },
      en: {
        title: "Poa̍h-poe--lah!(Funny Decision Maker)",
        askWhoLegend:"Who to ask?",
        whoGod:"A deity's name",
        whoAnc:"An ancestor (incl. passed relatives)",
        whoUni:"The universe / unseen forces",
        whoHelp:"Enter a deity’s title, or pick a different target.",
        yourName:"Your name / nickname",
        wish:"Question / intention",
        cupLegend:"❤️ Press to Choose Poe style",
        cupHint:"Note: all styles are cosmetic; odds are identical.",
        muteAllOn:  "🔇Mute all",
        muteAllOff: "🔈Sound on",
        prayTitle:"Say a sincere prayer, then toss",
        resTitle:"Response",
        back:"Back",
        next:"Next",
        toss:"Toss / poa̍h-poe",
        again:"Toss again",
        // outcomes
        ok:"Sîn-poe (OK): Approved — go for it!",
        bad:"Im-poe (No): Not approved — try another way.",
        meh:"Chhiò-poe (Hmm): Not clear yet — ask once more.",
        // labels
        who:"Target",
        you:"Player",
        topic:"Topic",
        streak: {
          meh: '❓❓❓ Three straight “Chhiò-poe (Hmm)”. Hint: <b>Make the call yourself!</b> 😆',
          bad: '🚫🚫🚫 Three straight “Im-poe (No)”. Hint: <b>Probably a hard no.</b> ❌',
          ok:  '🎉🎉🎉 Three straight “Sîn-poe (OK)”. Hint: <b>Go for it!</b> 😍'
        }
      }
    };

    // ===== UI i18n =====
    const langSel = $('#langSel');
    function applyI18N(){
      const t = I18N[S.lang] || I18N.zh;
      $$('[data-i]').forEach(el=>{ const k = el.getAttribute('data-i'); if(t[k]) el.textContent = t[k]; });
      document.title = t.title || '跋桮啦！(Poa̍h-poe--lah)';
      const h1 = document.getElementById('appTitle');
      if (h1) h1.textContent = t.title || '跋桮啦！(Poa̍h-poe--lah)';
    }
    langSel.value = S.lang; applyI18N();
    langSel.addEventListener('change', () => {
      S.lang = langSel.value;
      localStorage.setItem('lang', S.lang);

      applyI18N();                 // 換 UI 文案（按鈕/標題等）
      rebuildCupList();            // 重建桮卡片（名稱跟著換語言）
      syncPreviewsAndResult();     // 祈禱預覽 & 結果圖（含 alt）同步
      buildPrayerText();           // 祈禱文換語言
      buildResultLines(lastOutcome); // 結果區文案換語言
      updateMuteUI();  // 讓「靜音/開聲音」文字跟著語言切換
    });

    // ===== Global Mute（含 BGM + SFX）=====
  let audioMuted = JSON.parse(localStorage.getItem('audioMuted') || 'false');

  function updateMuteUI(){
    const t = I18N[S.lang] || {};
    $('#btnMute').textContent = audioMuted ? (t.muteAllOn || '🔇全部靜音')
                                           : (t.muteAllOff || '🔈開啟聲音');
    $('#btnMute').setAttribute('aria-pressed', String(audioMuted));
  }

  function setAudioMuted(muted){
    audioMuted = !!muted;
    localStorage.setItem('audioMuted', JSON.stringify(audioMuted));
    updateMuteUI();

    // 關閉時立刻停 BGM；開啟時若有選擇則恢復播放
    if (audioMuted) {
      stopBgm({ fadeOut:false });
    } else {
      const want = currentBgmId || $('#bgmSel')?.value;
      if (want) playBgm(want);
    }
  }

    // ===== SFX =====
    const SFX = {
      toss: 'assets/sounds/toss.ogg',
      ok:   'assets/sounds/ok.ogg',
      bad:  'assets/sounds/bad.ogg',
      meh:  'assets/sounds/meh.ogg',
      select: 'assets/sounds/select.ogg'
    };

  function playSfx(name){
    if (audioMuted) return;                 // 🔕 全域靜音：不播
    const src = SFX[name]; if(!src) return;

    // 依不同音效給不同 duck 時長（可再微調）
    const duckMs = (name === 'toss') ? 900 : 600;
    duckBgm(0.22, duckMs);

    try {
      const a = new Audio(src);
      a.muted = false;                      // 明確不靜音（交由 audioMuted 控制）
      a.volume = 1.0;
      a.play().catch(()=>{});
    } catch(e){}
  }

    // ===== BGM duck/unduck（投擲與結果時壓低音量，完了再拉回） =====
    let _duckTimer = null;
    let _bgmPrevVol = 0.5; // 你的預設音量（見 playBgm 裡）

  function duckBgm(toVol = 0.22, holdMs = 800){
    if (audioMuted) return;                 // 🔕 靜音時不要動 BGM
    if (!bgmAudio) return;
    if (_duckTimer === null) _bgmPrevVol = bgmAudio.volume;
    bgmAudio.volume = Math.max(0, Math.min(1, toVol));
    clearTimeout(_duckTimer);
    _duckTimer = setTimeout(()=>{
      if (bgmAudio) bgmAudio.volume = _bgmPrevVol;
      _duckTimer = null;
    }, holdMs);
  }

    // ===== 背景音樂（首頁可切換） =====
    let bgmAudio = null;
    let bgmMuted = false;
    let currentBgmId = null;

  function playBgm(id){
    if (!id) return;
    currentBgmId = id;

    // 🔕 全域靜音：直接不播，保持 state 即可
    if (audioMuted) return;

    stopBgm({fadeOut:false});
    const src = `assets/sounds/${id}.ogg`;
    bgmAudio = new Audio(src);
    bgmAudio.loop = true;
    bgmAudio.muted = false;
    bgmAudio.volume = 0.5;
    bgmAudio.play().catch(()=>{});
  }

    function stopBgm({fadeOut=true} = {}){
      if (!bgmAudio) return;
      if (!fadeOut){
        bgmAudio.pause();
        bgmAudio = null;
        currentBgmId = null;
        return;
      }
      const a = bgmAudio;
      const fade = setInterval(()=>{
        if (!a) { clearInterval(fade); return; }
        a.volume = Math.max(0, a.volume - 0.05);
        if (a.volume <= 0.01){
          clearInterval(fade);
          a.pause();
          if (bgmAudio === a) {
            bgmAudio = null;
            currentBgmId = null;
          }
        }
      }, 100);
    }

    // Mute 鈕
    $('#btnMute').addEventListener('click', ()=>{
      setAudioMuted(!audioMuted);
    });

    // 下拉切換
    const bgmSel = $('#bgmSel');
    bgmSel.addEventListener('change', ()=>{
      const id = bgmSel.value;
      playBgm(id);
    });

    // 初始化：自動播放預設 bg_01（待使用者互動後，且未靜音）
    document.body.addEventListener('click', ()=>{
      if (!bgmAudio && !audioMuted) playBgm('bg_01');
    }, { once: true });

    // ===== setup helpers =====
    function getRadio(name){ return (document.querySelector(`input[name="${name}"]:checked`)||{}).value; }
    function readSetup(){
      const whoType = getRadio('who');
      const whoName = (whoType==='god')? $('#whoName').value.trim() : (whoType==='ancestor')? $('#ancName').value.trim() : '';
      return {
        whoType, whoName,
        player: $('#player').value.trim() || '玩家',
        wish:   $('#wish').value.trim() || '（未輸入）',
        cup:    S.cup
      }
    }
    function buildPrayerText(){
      const t = I18N[S.lang]; const s = readSetup();
      const who =
        s.whoType==='god'      ? (s.whoName || (S.lang==='tl'?'某尊神明': S.lang==='en'?'a deity':'某尊神明')) :
        s.whoType==='ancestor' ? (s.whoName || (S.lang==='tl'?'某位祖先': S.lang==='en'?'an ancestor':'某mí祖先')) :
                                  (S.lang==='tl'?'宇宙天地冥冥之中力量' : S.lang==='en'?'the universe and unseen forces':'宇宙天地冥冥之中力量');

      let line;
      if (S.lang==='tl'){
        line = `🙏${who}🙏，信徒${s.player}虔誠祈求，為著「${s.wish}」請示指教。`;
      } else if (S.lang==='en'){
        line = `Dear ${who}, I (${s.player}) sincerely ask for guidance regarding: “${s.wish}”.`;
      } else { // zh
        line = `${who}在上，信徒（${s.player}）誠心祈求，為「${s.wish}」請示指引。`;
      }
      $('#prayText').textContent = line;
    }

    function cupLabel(c){
      if (c && typeof c.name === 'object') {
        return c.name[S.lang] || c.name.tl || c.name.en || c.name.zh || Object.values(c.name)[0];
      }
      return c?.name || '';
    }

    // ===== build cup list =====
    const cupList = $('#cupList');

  function rebuildCupList(){
    cupList.innerHTML = '';
    CUPS.forEach(c=>{
      const btn = document.createElement('button');
      btn.className='card';
      btn.type='button';
      btn.setAttribute('role','option');
      btn.setAttribute('aria-pressed', c.id===S.cup?'true':'false');
      btn.dataset.id = c.id;

      // 殼：thumb + label（thumb 先放空，再用 renderCupInto 塞入）
      btn.innerHTML = `<div class="thumb"></div><span class="label">${cupLabel(c)}</span>`;
      const th = btn.querySelector('.thumb');
      renderCupInto(th, c, 'yang');

      btn.addEventListener('click',()=>{
        playSfx('select');
        S.cup = c.id;
        $$('.card').forEach(x=>x.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');

        const cup = CUPS.find(x=>x.id===S.cup)||CUPS[0];
        renderCupInto($('#previewL'), cup, 'yang');
        renderCupInto($('#previewR'), cup, 'yin');
      });
      cupList.appendChild(btn);
    });
  }

    function ensureResultHolders(){
      const box = document.querySelector('#page-result .dice') || document.getElementById('page-result');
      if (!box) return;
      if (!document.getElementById('resL')) {
        const dl = document.createElement('div'); dl.id = 'resL'; dl.className = 'cup';
        box.appendChild(dl);
      }
      if (!document.getElementById('resR')) {
        const dr = document.createElement('div'); dr.id = 'resR'; dr.className = 'cup';
        box.appendChild(dr);
      }
    }

    // ===== 安全渲染杯子：支援 HTML 或 URL =====
  function renderCupInto(el, cup, side){
    if (!el || !cup) return;
    const out = cup.render(side);
    // 如果是 HTML 片段
    if (typeof out === 'string' && out.trim().startsWith('<')){
      el.innerHTML = out;
    } else {
      // 如果是純網址或其他型式 → 建立 <img>
      el.innerHTML = '';
      const img = document.createElement('img');
      img.src = String(out);
      img.alt = `${cupLabel(cup)} - ${side}`;
      img.decoding = 'async';
      img.loading = 'eager';
      el.appendChild(img);
    }
  }

  function syncPreviewsAndResult(){
    const cup = CUPS.find(c => c.id === S.cup) || CUPS[0];

    // 祈禱頁兩顆預覽
    const pl = $('#previewL'), pr = $('#previewR');
    if (pl && pr && cup) {
      renderCupInto(pl, cup, 'yang');
      renderCupInto(pr, cup, 'yin');
    }

    // 結果頁（若已顯示）
    if (!$('#page-result').hidden && lastOutcome && cup) {
      const l = $('#resL'), r = $('#resR');
      if (l) renderCupInto(l, cup, lastOutcome.L);
      if (r) renderCupInto(r, cup, lastOutcome.R);
    }
  }

  function renderPrayPreviews(){
    const cup = CUPS.find(c => c.id === S.cup) || CUPS[0];
    const pl = $('#previewL'), pr = $('#previewR');
    if (pl && pr && cup) {
      renderCupInto(pl, cup, 'yang');
      renderCupInto(pr, cup, 'yin');
    }
  }

  // 投擲 → 先彈跳(.cup) → 發光+左右擺動 → 輕晃收尾
  function applyTossAndShake(el, type){
    const cup = el.closest('.cup') || el;

    // 先清乾淨，避免殘留導致重播
    [el, cup].forEach(x => x && x.classList.remove('toss','bounce','sway','shake','glow'));
    void el.offsetWidth; // reflow

    const TOSS_MS   = 900;  // .toss 0.9s
    const BOUNCE_MS = 800;  // .bounceStrong 0.8s
    const SWAY_MS   = 1100; // .sway 1.1s
    const SHAKE_MS  = 600;  // .shake 0.6s

    // 1) 投擲
    el.classList.add('toss');

    setTimeout(() => {
      el.classList.remove('toss');

      // 2) 先彈（只套在 .cup）
      cup.classList.add('bounce');

      setTimeout(() => {
        // 👉 彈跳結束立刻拔掉，避免之後又被觸發
        cup.classList.remove('bounce');

        // 3) 發光 + 左右擺
        if (type) el.dataset.outcome = type; // ok / bad / meh
        el.classList.add('glow','sway');

        setTimeout(() => {
          // 4) 輕晃收尾
          el.classList.remove('sway');
          el.classList.add('shake');

          setTimeout(() => {
            // 5) 清理
            el.classList.remove('shake','glow');
            delete el.dataset.outcome;
          }, SHAKE_MS);
        }, SWAY_MS);
      }, BOUNCE_MS);
    }, TOSS_MS);
  }

    // ===== misc utils =====
  const hist = [];
  function historyPush(type){ hist.push(type); if(hist.length>9) hist.shift(); }
  function checkStreak(seq){
    if(hist.length < seq.length) return false;
    const n = seq.length;
    for(let i=0;i<=hist.length-n;i++){
      if(seq.every((v,k)=>hist[i+k]===v)) return true;
    }
    return false;
  }
  function resetStreak(){ hist.length = 0; }   // ✅ 重置彩蛋
  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

  // 小工具：把結果頁的 UI 一起清乾淨
  function clearResultUI(){
    $('#resLines')?.replaceChildren();
    const badge = $('#badge');
    if (badge){ badge.className = 'badge'; badge.textContent = ''; }
    $('#resL')?.replaceChildren();
    $('#resR')?.replaceChildren();
  }

  // ===== navigation（Hash 路由：四步流程）=====
  const PAGES = ['setup1','setup2','pray','result'];

  function show(page){
    PAGES.forEach(p=>{
      const el = document.getElementById('page-'+p);
      if (el) el.hidden = (p !== page);
    });

    // 工具列按鈕顯示規則
    const onSetup1 = page === 'setup1';
    const onSetup2 = page === 'setup2';
    const onPray   = page === 'pray';
    const onResult = page === 'result';

    // 語言選單只在 Step 1 顯示
    document.querySelector('.lang')?.toggleAttribute('hidden', !onSetup1);

    // 背景音效按鈕只在 Step 1 & Step 2 顯示
    document.getElementById('btnMute')
      ?.toggleAttribute('hidden', !(onSetup1 || onSetup2));

    $('#btnNext').hidden  = !(onSetup1 || onSetup2);  // [下一步]：只在 Step1 & Step2 顯示
    $('#btnBack').hidden  = onSetup1;  // [回設定]：除了 Step1 以外都顯示
    $('#btnToss').hidden  = !onPray;  // [跋桮]：只在祈禱頁顯示
    $('#btnAgain').hidden = !onResult;   // [再跋一擺]：只在結果頁顯示

    document.body.classList.toggle('is-result', onResult);
    window.scrollTo({ top: 0, behavior: 'smooth' });

    if (onPray){ buildPrayerText(); renderPrayPreviews(); }
    if (onResult){
      ensureResultHolders();
      _updateResultMinHeight();
    }
  }

  function currentPageFromHash(){
    const h = (location.hash || '').replace(/^#\//,'').trim();
    return PAGES.includes(h) ? h : 'setup1';
  }
  function goto(page){ location.hash = '#/' + (PAGES.includes(page)?page:'setup1'); }

  if (!location.hash) location.hash = '#/setup1';
  window.addEventListener('hashchange', ()=>{
    const p = currentPageFromHash();
    show(p);
    // ✅ 若是直接進到 Step2（而且之前有丟過一次），也重置 + 清 UI
    if (p === 'setup2' && ($('#badge')?.textContent || $('#resLines')?.children?.length)) {
      resetStreak();
      clearResultUI();
    }
  });
  show(currentPageFromHash());

  // ===== buttons（依目前頁面流向下一步）=====
  $('#btnNext').addEventListener('click', ()=>{
    const cur = currentPageFromHash();
    if (cur === 'setup1') {
      goto('setup2');               // Step1 -> Step2
    } else if (cur === 'setup2') {
      buildPrayerText();
      renderPrayPreviews();
      goto('pray');                 // Step2 -> Step3
    }
  });

  $('#btnBack').addEventListener('click', ()=>{
    const cur = currentPageFromHash();
    if (cur === 'setup2') {
      goto('setup1');                      // Step2 -> Step1
    } else if (cur === 'pray' || cur === 'result') {
      // ✅ 只有從祈禱/結果頁回到 Step2 才重置彩蛋 + 清 UI
      resetStreak();
      clearResultUI();
      goto('setup2');                      // 回到選桮頁
    }
  });

  // 新版：先微震 + 延遲 1 秒，再進結果頁與 toss()
  $('#btnToss').addEventListener('click', ()=>{
    // 2) 微震感（支援就震 60ms）
    try { if (navigator.vibrate) navigator.vibrate(60); } catch(_) {}

    // 防連點：暫時禁用 1.4 秒
    const btn = $('#btnToss');
    btn.disabled = true;
    setTimeout(()=>{ btn.disabled = false; }, 1400);

    setTimeout(()=>{
      goto('result');
      const res = document.getElementById('page-result');
      res.classList.remove('show');   // 先移除舊動畫
      void res.offsetWidth;           // 重新觸發 transition
      res.classList.add('show');      // 加入淡入效果

      $('#previewL').innerHTML = '';
      $('#previewR').innerHTML = '';
      ensureResultHolders();
      toss();
    }, 1000);
  });

  $('#btnAgain').addEventListener('click', ()=>{
    goto('pray');            // 回到祈禱頁
    // show('pray') 會自動 buildPrayerText() + renderPrayPreviews()
  });

    // ===== toss logic =====
  function toss(){
    playSfx('toss');
    const sides = ['yin','yang'];
    const L = sides[Math.random()<0.5?0:1];
    const R = sides[Math.random()<0.5?0:1];
    let type;
    if((L==='yin' && R==='yang') || (L==='yang' && R==='yin')) type='ok';
    else if(L==='yang' && R==='yang') type='bad';
    else type='meh';
    lastOutcome = {L,R,type};

    const cup = CUPS.find(c => c.id === S.cup) || CUPS[0];
    const l = $('#resL'), r = $('#resR');
    if (l) renderCupInto(l, cup, lastOutcome.L);
    if (r) renderCupInto(r, cup, lastOutcome.R);

    if (l) applyTossAndShake(l, type);
    if (r) applyTossAndShake(r, type);

    const t = I18N[S.lang];
    const badge = $('#badge');
    if (badge) {
      badge.className = 'badge ' + (type==='ok'?'ok': type==='bad'?'bad':'meh');
      badge.textContent = type==='ok'? t.ok : type==='bad'? t.bad : t.meh;
    }

    buildResultLines(lastOutcome);
    setTimeout(()=> playSfx(type), 120);
  }

    // ===== result lines =====
    function buildResultLines(outcome){
      const t = I18N[S.lang]; const s = readSetup(); if(!outcome) return;
      const who = s.whoType==='god' ? (s.whoName|| (S.lang==='tl'?'某位神明':'某位神明'))
                : s.whoType==='ancestor'? (s.whoName|| (S.lang==='tl'?'某位祖先':'某位祖先'))
                : (S.lang==='tl'?'宇宙天地冥冥之中力量':'宇宙天地冥冥之中力量');
      const box = $('#resLines'); box.innerHTML='';
      const add = (label, text)=>{ const d = document.importNode($('#tpl-line').content,true); d.querySelector('div').innerHTML = `<b>${label}：</b> ${escapeHtml(text)}`; box.appendChild(d); };
      add(t.who, who);
      add(t.you, s.player);
      add(t.topic, s.wish);
      // 彩蛋：偵測三連發
      historyPush(outcome.type);
      const tStreak = I18N[S.lang]?.streak;

      const eggBox = document.createElement('div');
      eggBox.className = 'small';

      if (checkStreak(['ok','ok','ok']) && tStreak?.ok) {
        eggBox.innerHTML = tStreak.ok;
        box.appendChild(eggBox);
      } else if (checkStreak(['bad','bad','bad']) && tStreak?.bad) {
        eggBox.innerHTML = tStreak.bad;
        box.appendChild(eggBox);
      } else if (checkStreak(['meh','meh','meh']) && tStreak?.meh) {
        eggBox.innerHTML = tStreak.meh;
        box.appendChild(eggBox);
      }

      // === 淡入顯示彩蛋 ===
      if (box.querySelector('.small')) {
        const egg = box.querySelector('.small:last-child');
        requestAnimationFrame(() => egg.classList.add('show'));
      }
    }

  function _updateResultMinHeight(){
    const res = document.getElementById('page-result');
    if (!res) return;
    const header = document.querySelector('header')?.offsetHeight || 64;
    const toolbar = document.querySelector('.toolbar')?.offsetHeight || 72;
    const mainPad = 16 * 2; // main 上下 padding 合計（你現在是 16px）
    const h = Math.max(280, window.innerHeight - (header + toolbar + mainPad));
    res.style.minHeight = h + 'px';
  }

  // 進到結果頁時算一次；旋轉/縮放也重算
  window.addEventListener('resize', _updateResultMinHeight);
  window.addEventListener('orientationchange', _updateResultMinHeight);

    // ===== 可摺疊 fieldset（自動套用到設定頁） =====
  function makeFieldsetFoldable(fs, {open=false, storageKey} = {}){
    if (!fs || fs.classList.contains('folded-ready')) return;
    fs.classList.add('fold','folded-ready');

    // 讀取儲存狀態（優先於 open 參數）
    const key = storageKey || `fold:${fs.id || fs.querySelector('legend')?.textContent || 'unnamed'}`;
    const saved = localStorage.getItem(key);
    const shouldOpen = saved ? (saved === '1') : !!open;

    // 取出 legend，其餘孩子包成內容區
    const legend = fs.querySelector('legend') || fs.insertAdjacentElement('afterbegin', document.createElement('legend'));
    const content = document.createElement('div');
    content.className = 'fold-content';
    while (legend.nextSibling) content.appendChild(legend.nextSibling); // 全部移入
    fs.appendChild(content);

    // 重新組 legend：文字 + caret
    const textSpan = document.createElement('span');
    textSpan.className = 'legend-text';
    textSpan.textContent = legend.textContent.trim() || '內容';
    legend.textContent = '';
    legend.appendChild(textSpan);

    const caret = document.createElement('i');
    caret.className = 'caret';
    legend.appendChild(caret);

    // 可點擊切換
    fs.setAttribute('aria-expanded', shouldOpen ? 'true':'false');
    if (shouldOpen){
      // 先讓它能展開到合適高度（先算內容高度）
      requestAnimationFrame(()=>{ fs.setAttribute('aria-expanded','true'); });
    }

    legend.addEventListener('click', ()=>{
      const openNow = fs.getAttribute('aria-expanded') === 'true';
      fs.setAttribute('aria-expanded', openNow ? 'false' : 'true');
      localStorage.setItem(key, openNow ? '0' : '1');
    });
  }

  // 把設定頁的三個區塊變成可摺疊
  function setupAccordion(){
    // 你現在的設定頁有三塊：求問對象 / 基本資料 / 桮樣式
    // 依實際 fieldset 順序自動套用：第 1 塊展開，其餘收合
    // 原：'#page-setup fieldset'
    const sets = Array.from(document.querySelectorAll('#page-setup1 fieldset'));
    sets.forEach((fs, idx)=>{
      makeFieldsetFoldable(fs, { open: idx === 0, storageKey: `poah:fold:${idx}` });
    });
  }

    // ===== init =====
    rebuildCupList();     // 先把卡片畫出來
    setupAccordion();     // 再把設定頁三個區塊掛上摺疊行為
    show('setup1');        // 進入設定頁
    $$('input[name="who"]').forEach(r=>{
      r.addEventListener('change',()=>{
        const v = getRadio('who'); S.whoType=v;
        $('#whoName').disabled = v!=='god';
        $('#ancName').disabled = v!=='ancestor';
      });
    });
    $('#whoName').disabled=false; $('#ancName').disabled=true;

    // Keyboard: press Enter/Space to toss on pray page
    document.addEventListener('keydown',(e)=>{
      if(!$('#page-pray').hidden && (e.key==='Enter'||e.key===' ')){ e.preventDefault(); $('#btnToss').click(); }
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // 這裡可以換成自訂 UI；簡單做就直接 reload
        window.location.reload();
      });
      navigator.serviceWorker.getRegistration().then((reg) => {
        if (!reg) return;
        if (reg.waiting) reg.waiting.postMessage('SKIP_WAITING');
        reg.addEventListener('updatefound', () => {
          const sw = reg.installing;
          if (!sw) return;
          sw.addEventListener('statechange', () => {
            if (sw.state === 'installed' && reg.waiting) {
              reg.waiting.postMessage('SKIP_WAITING');
            }
          });
        });
      });
    }
  </script>
  <script>
    (function () {
      // 如果你保留整頁滾動，就監聽 window；如果你把滾動限定在 main，就改成 const SCROLLER = document.querySelector('main');
      const SCROLLER = window;

      let startY = 0;

      // 記錄手指起始 Y
      window.addEventListener('touchstart', (e) => {
        const t = e.touches && e.touches[0];
        if (!t) return;
        startY = t.clientY;
      }, { passive: true });

      // 在「已經在頂端」且「手指往下拉」時，阻止預設（避免 iOS 橡皮筋 & PWA 空白）
      window.addEventListener('touchmove', (e) => {
        const t = e.touches && e.touches[0];
        if (!t) return;

        // 當前滾動位置（整頁時用 window.scrollY；如果 main 是滾動容器，就改用 main.scrollTop）
        const scrollTop = (SCROLLER === window)
          ? window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0
          : SCROLLER.scrollTop;

        const deltaY = t.clientY - startY;   // 往下拉時為正值

        if (scrollTop <= 0 && deltaY > 0) {
          // 在頂端又往下拉 → 阻止預設，避免觸發瀏覽器橡皮筋/刷新
          e.preventDefault();
        }
      }, { passive: false });
    })();
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    });
  }
  </script>
</body>
</html>
