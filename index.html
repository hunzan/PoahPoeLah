<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>è·‹æ¡®å•¦ï¼ PoaÌh-poe--lah!</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/icons/icon-192.png">
  <meta name="theme-color" content="#0b0b0f">
  <style>
  /* ========================
   *  Base variables & layout
   * ======================== */
  :root{
    --bg:#0b0b0f; --fg:#f2f4f8; --muted:#b9bcc6; --acc:#ffd452;
    --card:#141822; --glass:rgba(255,255,255,.06);

    --ok:#4caf50; --bad:#ef5350; --meh:#ffb020;

    /* === Result layout (single source of truth) === */
    --result-lift:120px;     /* çµæœå€æ•´å¡Šå¾€ä¸Šè²¼è¿‘ç¥ˆç¦±æ–‡çš„è·é›¢ */
    --res-h2-top:.8em;       /* ã€ŒæŒ‡ç¤ºçµæœã€ä¸Šæ–¹è·é›¢ï¼ˆå¤§ç´„ 2 è¡Œå…§ï¼‰ */
    --res-h2-bottom:1.2em;   /* ã€ŒæŒ‡ç¤ºçµæœã€èˆ‡æ¯åœ–è·é›¢ï¼ˆâ‰ˆ 2 è¡Œï¼‰ */
    --res-dice-bottom:1.6em; /* æ¯åœ–èˆ‡ä¸‹æ–¹æ–‡å­—è·é›¢ */
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; color:var(--fg); background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
  }
  main{ max-width:680px; margin:0 auto; padding:16px 16px 72px; }

  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,#0b0b0f 70%,#0b0b0f00);
    padding:12px 16px; display:flex; gap:8px; align-items:center;
  }
  h1{ font-size:22px; margin:0 8px 0 0; }
  .lang{ margin-left:auto; }

  /* ç¢ºä¿ hidden çœŸçš„éš±å½¢ã€ä¸å¯èšç„¦ã€å¾ç„¡éšœç¤™æ¨¹ç§»é™¤ */
  [hidden]{ display:none !important; }

  /* =========
   *  Controls
   * ========= */
  select,input,textarea,button{
    width:100%; padding:9px 10px; font-size:16px; border-radius:10px;
    color:var(--fg);
    background:rgba(15,19,32,.55);
    border:1px solid rgba(32,36,55,.6);
    -webkit-backdrop-filter:blur(4px); backdrop-filter:blur(4px);
  }
  textarea{ min-height:70px; resize:vertical }

  /* Glass blocks */
  fieldset,.card,.prayer{
    background:rgba(15,20,34,.55);
    border:1px solid rgba(31,36,53,.7);
    -webkit-backdrop-filter:blur(4px); backdrop-filter:blur(4px);
  }
  legend{ padding:0 8px; color:#d6daea; }
  .row{ display:grid; grid-template-columns:1fr; gap:12px; }

  /* =====
   * Cards
   * ===== */
  .cards{
    display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
  }
  .card{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    border-radius:16px; padding:10px; cursor:pointer; outline:none;
    -webkit-backdrop-filter:blur(5px) saturate(130%); backdrop-filter:blur(5px) saturate(130%);
    transition:all .25s ease;
  }
  .card[aria-pressed="true"], .card:focus{
    box-shadow:0 0 0 2px var(--acc) inset; background:rgba(255,255,255,.12);
  }
  .thumb{ background:rgba(255,255,255,.12); border-radius:12px; -webkit-backdrop-filter:blur(3px); backdrop-filter:blur(3px); }
  .cards .label{ display:block; text-align:center; margin-top:6px; font-size:14px; color:#f2f4f8; text-shadow:0 1px 2px rgba(0,0,0,.4); }

  /* =======
   * Toolbar
   * ======= */
  .toolbar{
    position:fixed; left:0; right:0; bottom:0;
    background:linear-gradient(180deg,transparent,rgba(0,0,0,.25)),#0b0b0f;
    padding:12px 16px; display:flex; gap:12px; z-index:20;
  }
  .btn{ background:#1a2140; border:1px solid #232a52; color:#fff; padding:12px 14px; border-radius:14px; font-size:18px; }
  .btn.primary{ background:linear-gradient(180deg,#2a3568,#1f2852); border-color:#3b4aa8; }
  .btn.ghost{ background:#0f1320; }

  /* =========
   * Content UI
   * ========= */
  .center{ display:grid; place-items:center; }
  .prayer{ line-height:1.7; color:#dfe3f3; border-style:dashed; border-radius:16px; padding:14px; }
  .result{ display:grid; gap:12px; }

  /* ========
   * Dice/Cup
   * ======== */
  .dice{ display:flex; justify-content:center; gap:28px; margin:8px 0 16px; }
  .cup{
    position:relative; overflow:visible;
    width:clamp(96px,30vw,140px); height:clamp(96px,30vw,140px);
    display:grid; place-items:center;
  }
  .cup img,.cup svg{
    max-width:85%; max-height:85%; width:auto; height:auto; object-fit:contain;
  }

  /* Animations */
  .float{ animation:float 2s ease-in-out infinite; }
  @keyframes float{ 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }
  .toss{ animation:toss .9s cubic-bezier(.2,.8,.2,1); }
  @keyframes toss{ 0%{transform:translateY(-20vh) rotate(-40deg); opacity:.7} 60%{transform:translateY(0) rotate(0)} 80%{transform:translateY(-5px)} 100%{transform:translateY(0); opacity:1} }
  .bounce{ animation:bounceStrong .8s cubic-bezier(.25,.65,.35,1.3); }
  @keyframes bounceStrong{ 0%{transform:translateY(0)} 20%{transform:translateY(20px)} 40%{transform:translateY(-24px)} 55%{transform:translateY(12px)} 70%{transform:translateY(-10px)} 85%{transform:translateY(4px)} 100%{transform:translateY(0)} }
  .sway{ animation:swayFew 1.1s ease-in-out forwards; }
  @keyframes swayFew{ 0%{rotate:0} 10%{rotate:-10deg} 25%{rotate:10deg} 40%{rotate:-8deg} 60%{rotate:8deg} 80%{rotate:-4deg} 100%{rotate:0} }
  @media (prefers-reduced-motion:reduce){ .sway,.shake,.toss{ animation:none!important; } }

  /* =====
   * Badge
   * ===== */
  .badge{
    display:inline-block; padding:.25rem .5rem; border-radius:999px; font-size:16px;
    border:1px solid #2a3152; background:#101424; color:#ccd2ea; margin-top:2em;
  }
  .ok{ color:#e8ffe8; border-color:#2f6b3a; background:rgba(76,175,80,.5); }
  .bad{ color:#ffecec; border-color:#7b3434; background:rgba(239,83,80,.5); }
  .meh{ color:#fff2e0; border-color:#7b5a24; background:rgba(255,176,32,.5); }

  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  .small{ font-size:12px; color:#aeb6d8; }

  /* =======================
   * Result page (unified!)
   * ======================= */
  #page-result h2{ margin: var(--res-h2-top) 0 var(--res-h2-bottom) !important; }
  #page-result .dice{ margin: 0 0 var(--res-dice-bottom) !important; }
  #resLines{ background:rgba(0,0,0,.4); border-radius:14px; padding:10px 12px; }
  #resLines b{ font-weight:600; color:#fff9cc; }

  /* ç™¼å…‰ï¼šä¾çµæœè®Šè‰² */
  .glow{ position:relative; z-index:1; }
  .glow::after{
    content:""; position:absolute; inset:-40px; border-radius:50%;
    background:radial-gradient(circle, rgba(255,223,100,.55) 0%, rgba(255,223,100,.35) 25%, rgba(255,223,100,.15) 50%, rgba(255,223,100,0) 80%);
    filter:blur(12px); opacity:0; animation:glowTwice 1.4s ease-in-out;
  }
  @keyframes glowTwice{ 0%,100%{opacity:0; transform:scale(1)} 20%{opacity:.9; transform:scale(1.1)} 35%{opacity:0} 55%{opacity:.8; transform:scale(1.15)} 70%{opacity:0} }
  .glow[data-outcome="bad"]::after{ background:radial-gradient(circle, rgba(180,180,180,.5) 0%, rgba(160,160,160,.3) 25%, rgba(130,130,130,.1) 50%, rgba(0,0,0,0) 80%); }
  .glow[data-outcome="meh"]::after{ background:radial-gradient(circle, rgba(255,170,50,.55) 0%, rgba(255,140,30,.35) 25%, rgba(255,110,0,.15) 50%, rgba(255,100,0,0) 80%); }

  /* é¡¯ç¤ºçµæœæ™‚æŠŠæ•´å¡Šå¾€ä¸Šè²¼è¿‘ç¥ˆç¦±æ–‡ */
  body.is-result #page-result{ margin-top:calc(-1 * var(--result-lift)); }
  body.is-result main{ padding-top:4px; }

  /* åªä¿ç•™å½©è›‹æ¢ï¼Œå…¶ä»–å¸¸é§èªªæ˜éš±è— */
  #resLines > div:not(.small){ display:none; }
  body.is-result #resLines .small{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:calc(72px + 12px);
    width:min(92vw,680px); z-index:15;
    text-align:left; font-size:14px; color:#f6f8ff;
    background:rgba(0,0,0,.55); border-radius:12px; padding:8px 12px;
    box-shadow:0 6px 24px rgba(0,0,0,.25);
  }
  #resLines .small{ opacity:0; transition:opacity .2s ease; }
  #resLines .small.show{ opacity:1; }

  /* è®“çµæœåœ–å®¹å™¨ç©©å®šç½®ä¸­èˆ‡å°ºå¯¸ */
  #page-result .cup{ display:grid; place-items:center; width:clamp(96px,30vw,140px); height:clamp(96px,30vw,140px); }
  #page-result .cup img,#page-result .cup svg{ max-width:90%; max-height:90%; width:auto; height:auto; display:block; object-fit:contain; }

  /* ========
   * Accordeon
   * ======== */
  fieldset.fold{ overflow:hidden; padding:0; }
  fieldset.fold > legend{
    display:flex; align-items:center; gap:8px;
    padding:12px; margin:0; cursor:pointer; user-select:none;
    border-bottom:1px solid #1f2435;
  }
  fieldset.fold > legend .legend-text{ flex:1; color:#d6daea; font-weight:600; }
  fieldset.fold > legend .caret{ width:10px; height:10px; transform:rotate(0); border-right:2px solid #cfd3e6; border-bottom:2px solid #cfd3e6; margin-left:6px; transition:transform .18s ease; }
  fieldset.fold[aria-expanded="true"] > legend .caret{ transform:rotate(45deg); }
  fieldset.fold[aria-expanded="false"] > legend .caret{ transform:rotate(-135deg); }
  .fold-content{
    padding:10px 12px 12px; display:grid; gap:12px; max-height:0; overflow:hidden; transition:max-height .22s ease;
    background:rgba(255,255,255,.04); -webkit-backdrop-filter:blur(9px) saturate(150%); backdrop-filter:blur(9px) saturate(150%);
    border-top:1px solid rgba(255,255,255,.25); border-bottom:1px solid rgba(255,255,255,.12); box-shadow:0 2px 12px rgba(0,0,0,.1);
  }
  .fold-content label,.fold-content span[data-i],.fold-content input,.fold-content textarea{ font-size:17px; line-height:1.6; }
  .fold-content .small{ font-size:14px; color:#e6e9f5; }
  fieldset.fold[aria-expanded="true"] > .fold-content{ max-height:800px; }

  /* ======
   * Header
   * ====== */
  .bgm select{
    padding:6px 10px; font-size:14px; border-radius:10px; margin-left:8px;
    background:#0f1320; color:#f2f4f8; border:1px solid #202437;
  }

  /* =========
   * Background
   * ========= */
  body::before{
    content:""; position:fixed; inset:0;
    background:url("assets/images/bg.webp") center/cover no-repeat fixed;
    opacity:1; filter:none; z-index:-1;
  }

  /* =================
   * Mobile adjustments
   * ================= */
  @media (max-width:480px),(max-height:740px){
    body,main{ font-size:15px; line-height:1.45; }
    main{ padding:8px 12px 72px; max-width:560px; }

    header{ padding:8px 10px; }
    h1{ font-size:18px; margin-right:6px; }

    fieldset{ padding:10px; border-radius:12px; }
    legend{ font-size:15px; margin-bottom:4px; }
    label{ font-size:14px; }

    .row{ gap:10px; }
    .cards{ gap:8px; }
    .card{ padding:8px; border-radius:10px; }
    .thumb{ border-radius:8px; }
    .cards .label{ font-size:11.5px; margin-top:3px; }

    .toolbar{ padding:8px 10px; gap:6px; }
    .btn{ padding:10px 12px; font-size:16px; border-radius:12px; }

    /* Pray page brief */
    #page-pray h2{ margin:0 0 4px; font-size:16px; font-weight:600; opacity:.9; }
    #page-pray .prayer{
      font-size:14px; padding:10px; margin:0 0 6px; line-height:1.5;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    #page-pray .dice{ gap:14px; margin:4px 0 8px; }

    /* ç”¨ã€Œèª¿è®Šæ•¸ã€ä¾†æ§åˆ¶çµæœé é–“è·ï¼ˆè¦å‰‡ä¸é‡å¯«ï¼‰ */
    :root{
      --result-lift:132px;
      --res-h2-top:.7em;
      --res-h2-bottom:1.1em;
      --res-dice-bottom:1.4em;
    }
  }
    /* ===== Step 1: è¨­å®šé è¼¸å…¥æ¨™é¡Œå¼·åŒ–ï¼ˆé»ƒè‰² + æ”¾å¤§ï¼‰ ===== */

  /* fieldset æ¨™é¡Œï¼ˆä¾‹å¦‚ æ±‚å•å°è±¡ã€é¸æ“‡æ¡®æ¬¾å¼ï¼‰ */
  #setupForm > fieldset > legend,
  #setupForm > fieldset > legend .legend-text {
    color: var(--acc);          /* ä½¿ç”¨ä½ çš„ä¸»é¡Œé»ƒè‰² */
    font-size: 22px;            /* æ”¾å¤§å­—é«” */
    font-weight: 800;
    text-align: center;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.25);
  }

  /* å–®ç¨è¼¸å…¥é …ç›®æ¨™é¡Œï¼ˆä¾‹å¦‚ æ±‚å•è€…å§“åï¼æš±ç¨±ã€æ±‚å•äº‹é …ï¼‰ */
  #setupForm > label > span[data-i] {
    display: block;
    color: var(--acc);
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    margin: 8px 0 10px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.25);
  }

  /* æ‰‹æ©Ÿå¾®èª¿ */
  @media (max-width:480px) {
    #setupForm > fieldset > legend,
    #setupForm > fieldset > legend .legend-text {
      font-size: 20px;
    }
    #setupForm > label > span[data-i] {
      font-size: 18px;
      margin: 6px 0 8px;
    }
  }
  /* ===== ç¥ˆç¦±é ï¼šç¥è–æ¼‚æµ®ï¼‹å…‰æšˆç‰¹æ•ˆ ===== */
  #page-pray .cup {
    position: relative;
    transform: scale(1.28);                 /* æ”¾å¤§ */
    transition: transform .3s ease;
    z-index: 0;                             /* çµ¦ halo ç–Šå±¤ç”¨ */
  }

  /* åœ–åƒå¾®æ“ºé ­ï¼ˆæ›´æœ‰æ´»è‘—çš„æ„Ÿè¦ºï¼‰ */
  #page-pray .cup img,
  #page-pray .cup svg {
    animation:
      holyYaw 6s ease-in-out infinite,
      holyBreath 5.5s ease-in-out infinite;
    filter:
      drop-shadow(0 10px 14px rgba(0,0,0,.45))
      drop-shadow(0 0 10px rgba(255,212,82,.22));
    will-change: transform, filter;
  }

  /* é‡‘è‰²å…‰æšˆï¼ˆè„ˆå‹•å…©å±¤ï¼‰ */
  #page-pray .cup::after {
    content: "";
    position: absolute;
    inset: -32%;
    border-radius: 50%;
    pointer-events: none;
    background:
      radial-gradient(circle,
        rgba(255,223,120,.55) 0%,
        rgba(255,223,120,.25) 35%,
        rgba(255,223,120,.10) 58%,
        rgba(255,223,120,0) 75%);
    filter: blur(10px);
    animation: haloPulse 3.2s ease-in-out infinite;
    z-index: -1; /* åœ¨æ¡®å¾Œé¢ */
  }

  /* æ‰‹æ©Ÿç•¥ç¸®ï¼Œé¿å…è¶…æ¡† */
  @media (max-width:480px){
    #page-pray .cup { transform: scale(1.18); }
  }

  /* å‹•ç•«å®šç¾©ï¼šå¾®æ“ºé ­ã€è¼•å‘¼å¸ã€å…‰æšˆè„ˆå‹• */
  @keyframes holyYaw {
    0%   { transform: rotateZ(-2deg) }
    50%  { transform: rotateZ( 2deg) }
    100% { transform: rotateZ(-2deg) }
  }
  @keyframes holyBreath {
    0%,100% { transform: scale(1) }
    50%     { transform: scale(1.02) }
  }
  @keyframes haloPulse {
    0%,100% { opacity:.55; transform: scale(1) }
    40%     { opacity:.85; transform: scale(1.06) }
    70%     { opacity:.35; transform: scale(1.12) }
  }

  /* ä½¿ç”¨è€…åå¥½ã€Œæ¸›å°‘å‹•æ…‹ã€ï¼šåªç•™æŸ”å’Œé™°å½± */
  @media (prefers-reduced-motion: reduce){
    #page-pray .cup img,
    #page-pray .cup svg { animation: none !important; }
    #page-pray .cup::after { animation: none !important; opacity: .5; }
  }
  /* === çµæœé å°é½Šä¿®æ­£ï¼šç½®ä¸­é¡¯ç¤ºï¼Œä¸å†ä¸Šæéé ­ === */
  body.is-result #page-result{
    margin-top: 0 !important;            /* å–æ¶ˆåŸå…ˆçš„è² ä¸Šæ */
    min-height: calc(100svh - 152px);    /* è¦–çª—é«˜ - (header+toolbar) çš„ä¼°å€¼ */
    display: grid;
    align-content: center;               /* å‚ç›´ç½®ä¸­å…§å®¹ */
  }

  /* çµæœé çš„å…©é¡†æ¯åœ–ï¼šæ°´å¹³ç½®ä¸­ï¼Œä¿ç•™ä½ åŸæœ¬çš„ä¸‹æ–¹é–“è·è®Šæ•¸ */
  #page-result .dice{
    justify-content: center;
    margin: 0 0 var(--res-dice-bottom) !important;
  }
  #btnToss {
    background: radial-gradient(circle at 50% 35%, #ff6666 0%, #cc0000 70%, #660000 100%);
    border: 2px solid #ffaaaa;
    color: #fffdf5;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0,0,0,.4);
    box-shadow:
      0 0 12px rgba(255,80,80,0.6),
      0 0 30px rgba(255,50,50,0.3);
    transition: all .2s ease-in-out;
  }
  #btnToss:hover {
    transform: scale(1.05);
    box-shadow:
      0 0 18px rgba(255,120,120,0.75),
      0 0 40px rgba(255,60,60,0.45);
  }
  #btnToss:active {
    transform: scale(0.97);
    background: radial-gradient(circle at 50% 35%, #dd3333 0%, #aa0000 70%, #550000 100%);
  }
  /* === çµæœé æ·¡å…¥å‹•ç•« === */
  #page-result {
    opacity: 0;
    transition: opacity 0.8s ease;   /* æ·¡å…¥é€Ÿåº¦ */
  }

  #page-result.show {
    opacity: 1;
  }
  </style>

</head>
<body>
  <header>
    <h1 id="appTitle">è·‹æ¡®å•¦ï¼(PoaÌh-poe--lah!)</h1>
    <div class="lang">
      <label class="sr-only" for="langSel">èªè¨€</label>
      <select id="langSel" aria-label="èªè¨€">
        <option value="tl">å°èª</option>
        <option value="en">English</option>
        <option value="zh">è¯èª</option>
      </select>
    </div>
    <div class="bgm">
  <label class="sr-only" for="bgmSel">èƒŒæ™¯éŸ³æ¨‚</label>
    <select id="bgmSel" aria-label="èƒŒæ™¯éŸ³æ¨‚">
      <option value="bg_01" selected>è–æ¨‚ã®éŸ³</option>
      <option value="bg_02">é¢¨éˆ´ã®éŸ³</option>
      <option value="bg_03">æµ·æ´‹ã®éŸ³</option>
      <option value="bg_04">è‡ªç„¶ã®éŸ³</option>
    </select>
  </div>
  </header>
  <main>
  <!-- ===== Step 1. æ±‚å•è¨­å®š ===== -->
  <section id="page-setup1" aria-labelledby="setupTitle">
    <h2 id="setupTitle" class="sr-only">è¨­å®š</h2>
    <div class="row" id="setupForm">
      <fieldset>
        <legend data-i="askWhoLegend">æ±‚å•å°è±¡</legend>
        <div class="row">
          <label><input type="radio" name="who" value="god" checked> <span data-i="whoGod">æŸå°Šç¥æ˜ï¼ˆè¼¸å…¥ç¥æ˜ç¨±è™Ÿï¼‰</span></label>
          <input id="whoName" type="text" placeholder="åª½ç¥–ï¼é—œè–å¸å›ï¼è€¶ç©Œâ€¦" aria-describedby="whoHelp" />
          <label><input type="radio" name="who" value="ancestor"> <span data-i="whoAnc">æŸä½ç¥–å…ˆï¼ˆæˆ–éä¸–è¦ªäººï¼‰</span></label>
          <input id="ancName" type="text" placeholder="é˜¿å…¬ï¼é˜¿å¬¤ï¼é˜¿ç¥–â€¦" />
          <label><input type="radio" name="who" value="universe"> <span data-i="whoUni">å‘å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡æ±‚å•</span></label>
        </div>
      </fieldset>

      <label>
        <span data-i="yourName">æ±‚å•è€…å§“åï¼æš±ç¨±</span>
        <input id="player" type="text" placeholder="è¼¸å…¥ä½ çš„åå­—ï¼æš±ç¨±" />
      </label>

      <label>
        <span data-i="wish">æ±‚å•äº‹é …</span>
        <textarea id="wish"></textarea>
      </label>
    </div>
  </section>

  <!-- ===== Step 2. é¸æ“‡æ¡®æ¬¾å¼ ===== -->
  <section id="page-setup2" aria-labelledby="cupTitle" hidden>
    <h2 id="cupTitle">é¸æ“‡æ¡®æ¬¾å¼</h2>
    <div id="cupList" class="cards" role="listbox" aria-label="æ¯æ¬¾å¼"></div>
    <div class="small" data-i="cupHint">ğŸ”” å°æé†’ï¼šç„¡ä»æ¬¾å¼åªæ˜¯å¤–å½¢ï¼Œéˆé©—åº¦ç„¡å·®å–”ï½</div>
  </section>


    <!-- ===== Step 3. ç¥ˆç¦±é  ===== -->
    <section id="page-pray" hidden aria-labelledby="prayTitle" class="center">
      <div style="width:100%">
        <h2 id="prayTitle" data-i="prayTitle">å…ˆèª å¿ƒç¥ˆç¦±ï¼Œå†è·‹æ¡®</h2>
        <p class="prayer" id="prayText"></p>
        <div class="dice">
          <div class="cup float" id="previewL"></div>
          <div class="cup float" id="previewR"></div>
        </div>
      </div>
    </section>

    <!-- ===== Step 4. çµæœé  ===== -->
    <section id="page-result" hidden aria-labelledby="resTitle">
      <h2 id="resTitle" data-i="resTitle">æŒ‡ç¤ºçµæœ</h2>
      <div class="dice">
        <div class="cup" id="resL"></div>
        <div class="cup" id="resR"></div>
      </div>
      <div class="result">
        <div><span class="badge" id="badge"></span></div>
        <div id="resLines"></div>
      </div>
    </section>
  </main>

  <div class="toolbar" role="group" aria-label="æ“ä½œ">
    <button class="btn ghost" id="btnBack" data-i="back">å›è¨­å®š</button>
    <button class="btn" id="btnNext" data-i="next">ä¸‹ä¸€æ­¥</button>
    <button class="btn primary" id="btnToss" data-i="toss" hidden>è·‹æ¡® / poaÌh-poe</button>
    <button class="btn" id="btnAgain" data-i="again" hidden>å†è·‹ä¸€æ“º</button>
    <button class="btn ghost" id="btnMute">èƒŒæ™¯éŸ³æ•ˆğŸ”ˆ</button>
  </div>

  <template id="tpl-line"><div class="small"></div></template>

  <!-- ä¸»é‚è¼¯ï¼šä½¿ç”¨ ES Modulesï¼Œç›´æ¥ import CUPS -->
  <script type="module">
    import { CUPS as REG_CUPS } from './js/cups/registry.js';

    // ===== helpers =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // ===== i18n åˆå§‹èªè¨€ï¼ˆå…ˆç®—å‡º langï¼Œå†å»ºç«‹ Sï¼‰=====
    let initialLang = localStorage.getItem('lang');
    if (!initialLang) {
      const sys = (navigator.language || 'zh').toLowerCase();
      if (sys.startsWith('en')) initialLang = 'en';
      else if (sys.startsWith('zh') || sys.startsWith('cmn')) initialLang = 'zh';
      else if (sys.includes('nan') || sys.includes('hak') || sys.includes('tw')) initialLang = 'tl';
      else initialLang = 'zh';
      localStorage.setItem('lang', initialLang);
    }

    // ===== stateï¼ˆåªä¿ç•™é€™ä¸€çµ„ï¼‰=====
    const CUPS = REG_CUPS;
    if (!CUPS || !CUPS.length) {
      console.error('CUPS è¼‰å…¥å¤±æ•—ï¼šè«‹æª¢æŸ¥ js/cups/manifest.js / registry.js');
    }
    const S = { lang: initialLang, cup: CUPS?.[0]?.id || '', whoType: 'god' };

    // ğŸ”¸ ææ—©å®£å‘Šï¼Œé¿å… applyI18N() é¦–æ¬¡åŸ·è¡Œæ™‚å–ä¸åˆ°
    let lastOutcome = null;

    // ===== i18n =====
    const I18N = {
      zh: {
        askWhoLegend:"æ±‚å•å°è±¡", whoGod:"æŸå°Šç¥æ˜ï¼ˆè¼¸å…¥ç¥æ˜ç¨±è™Ÿï¼‰", whoAnc:"æŸä½ç¥–å…ˆï¼ˆå«éä¸–è¦ªäººï¼‰", whoUni:"å‘å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡æ±‚å•",
        whoHelp:"è¼¸å…¥ç¥æ˜ç¨±è™Ÿï¼Œæˆ–æ”¹é¸å…¶ä»–å°è±¡", yourName:"æ±‚å•è€…å§“åï¼æš±ç¨±", wish:"æ±‚å•äº‹é …",
        cupLegend:"â¤ï¸ æŒ‰ä¸‹é¸ç­Š", cupHint:"å°æé†’ï¼šä¸åŒæ¨£å¼åªæ˜¯å¤–è§€ï¼Œæ©Ÿç‡ä¸€æ¨£å•¦ï½",
        prayTitle:"å…ˆèª å¿ƒç¥ˆç¦±ï¼Œå†æ“²ç­Š", resTitle:"æŒ‡ç¤ºçµæœ",
        muteAllOn:  "ğŸ”‡å…¨éƒ¨éœéŸ³",
        muteAllOff: "ğŸ”ˆé–‹å•Ÿè²éŸ³",
        back:"å›è¨­å®š", next:"ä¸‹ä¸€æ­¥", toss:"æ“²ç­Š", again:"å†æ“²ä¸€æ¬¡",
        ok:"è–æ¯ï¼šå¾—åˆ°æ‡‰å…ï¼Œå»åšå°±å°äº†ï¼",
        bad:"é™°æ¯ï¼šç¥æ˜èªªä¸è¡Œï¼Œæ›å€‹æ–¹æ³•å§ã€‚",
        meh:"ç¬‘æ¯ï¼šç¥æ˜ï¼å…ˆäººï¼ç¥ç§˜åŠ›é‡ç¬‘äº†ï¼Œå¯èƒ½é‚„æ²’æ—¨æ„ï¼Œæˆ–æ˜¯æ²’è½æ‡‚ä½ çš„æ„æ€ï¼Œè«‹å†å•ä¸€æ¬¡ã€‚",
        who:"æ±‚å•å°è±¡", you:"æ±‚å•è€…", topic:"äº‹é …",
        streak: {
          meh: 'â“â“â“ é€£çºŒä¸‰æ“ºã€Œç¬‘æ¯ã€ï¼Œå»ºè­°ï¼š<b>è‡ªå·±åšä¸»ï¼ğŸ˜†</b>',
          bad: 'ğŸš«ğŸš«ğŸš« é€£çºŒä¸‰æ“ºã€Œé™°æ¯ã€ï¼Œå»ºè­°ï¼š<b>çœŸçš„ä¸è¡Œå–”ï¼âŒ</b>',
          ok:  'ğŸ‰ğŸ‰ğŸ‰ é€£çºŒä¸‰æ“ºã€Œè–æ¯ã€ï¼Œå»ºè­°ï¼š<b>å»åšå°±å°ï¼ğŸ˜</b>'
        }
      },
      tl: {
        askWhoLegend:"æ±‚å•å°è±¡", whoGod:"æŸå°Šç¥æ˜ï¼ˆè¼¸å…¥ç¥æ˜ç¨±è™Ÿï¼‰", whoAnc:"æŸmÃ­ç¥–å…ˆï¼ˆåŒ…æ‹¬éèº«è¦ªäººï¼‰", whoUni:"Ç¸gå®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡æ±‚å•",
        whoHelp:"è¼¸å…¥ç¥æ˜ç¨±è™Ÿï¼Œæˆ–æ”¹é¸å…¶ä»–å°è±¡", yourName:"æ±‚å•è€…å§“åï¼æš±ç¨±", wish:"æ±‚å•äº‹é …",
        cupLegend:"â¤ï¸ æ¤é®é¸æ¡®", cupHint:"æç¤ºï¼šæ¬¾å¼ä»æ¬¾ï¼Œæ©Ÿç‡è¢‚è®Šï½",
        prayTitle:"èª å¿ƒç¥ˆæ±‚äº†å¾Œï¼Œæ¤è½å»è·‹æ¡®", resTitle:"æŒ‡ç¤ºçµæœ",
        muteAllOn:  "ğŸ”‡å…¨éƒ¨éœéŸ³",
        muteAllOff: "ğŸ”ˆæ”¾é€è²éŸ³",
        back:"å€’è½‰--å»", next:"å¾Œä¸€æ­¥", toss:"è·‹æ¡® / poaÌh-poe", again:"é–£è·‹ä¸€æ“º",
        ok:"ç¥æ¡®ï¼ˆsÃ®n-poe / siÅ«â¿-poeï¼‰ï¼šå¾—è‘—æ‡‰å…ï¼Œä½ Ãªç¥ˆæ±‚æœƒå¯¦ç¾ï¼",
        bad:"é™°æ¡®ï¼ˆim-poe / bÃ´-poeï¼‰ï¼šæ¯‹é€šå–”ï¼Œæ›ä¸€æ¬¾åšæ³•ã€‚",
        meh:"ç¬‘æ¡®ï¼ˆchhiÃ²-poeï¼‰ï¼šç¥æ˜ï¼å…ˆäººï¼ç¥ç§˜åŠ›é‡ç¬‘ç¬‘lehï¼Œå¯èƒ½çŒ¶æœªæœ‰æ—¨æ„ï¼ŒæŠ‘æ˜¯è½ç„¡ä½ Ãªæ„æ€ã€‚",
        who:"æ±‚å•å°è±¡", you:"ç¥ˆæ±‚è€…", topic:"æ±‚å•¥ä»£èªŒ",
        streak: {
          meh: 'â“â“â“ é€£çºŒä¸‰æ“ºã€Œç¬‘æ¡®ã€ï¼Œå»ºè­°ï¼š<b>å®¶å·±æ±ºå®šå•¦ï¼ğŸ˜†</b>',
          bad: 'ğŸš«ğŸš«ğŸš« é€£çºŒä¸‰æ“ºã€Œé™°æ¡®ã€ï¼Œå»ºè­°ï¼š<b>çœŸæ­£æ¯‹é€šå–”ï¼âŒ</b>',
          ok:  'ğŸ‰ğŸ‰ğŸ‰ é€£çºŒä¸‰æ“ºã€Œç¥æ¡®ã€ï¼Œå»ºè­°ï¼š<b>åšå°±è‘—å•¦ï¼ğŸ˜</b>'
        }
      },
      en: {
        title: "PoaÌh-poe--lah!(Funny Decision Maker)",
        askWhoLegend:"Who to ask?",
        whoGod:"A deity's name",
        whoAnc:"An ancestor (incl. passed relatives)",
        whoUni:"The universe / unseen forces",
        whoHelp:"Enter a deityâ€™s title, or pick a different target.",
        yourName:"Your name / nickname",
        wish:"Question / intention",
        cupLegend:"â¤ï¸ Press to Choose Poe style",
        cupHint:"Note: all styles are cosmetic; odds are identical.",
        muteAllOn:  "ğŸ”‡Mute all",
        muteAllOff: "ğŸ”ˆSound on",
        prayTitle:"Say a sincere prayer, then toss",
        resTitle:"Response",
        back:"Back",
        next:"Next",
        toss:"Toss / poaÌh-poe",
        again:"Toss again",
        // outcomes
        ok:"SÃ®n-poe (OK): Approved â€” go for it!",
        bad:"Im-poe (No): Not approved â€” try another way.",
        meh:"ChhiÃ²-poe (Hmm): Not clear yet â€” ask once more.",
        // labels
        who:"Target",
        you:"Player",
        topic:"Topic",
        streak: {
          meh: 'â“â“â“ Three straight â€œChhiÃ²-poe (Hmm)â€. Hint: <b>Make the call yourself!</b> ğŸ˜†',
          bad: 'ğŸš«ğŸš«ğŸš« Three straight â€œIm-poe (No)â€. Hint: <b>Probably a hard no.</b> âŒ',
          ok:  'ğŸ‰ğŸ‰ğŸ‰ Three straight â€œSÃ®n-poe (OK)â€. Hint: <b>Go for it!</b> ğŸ˜'
        }
      }
    };

    // ===== UI i18n =====
    const langSel = $('#langSel');
    function applyI18N(){
      const t = I18N[S.lang] || I18N.zh;
      $$('[data-i]').forEach(el=>{ const k = el.getAttribute('data-i'); if(t[k]) el.textContent = t[k]; });
      document.title = t.title || 'è·‹æ¡®å•¦ï¼(PoaÌh-poe--lah)';
      const h1 = document.getElementById('appTitle');
      if (h1) h1.textContent = t.title || 'è·‹æ¡®å•¦ï¼(PoaÌh-poe--lah)';
    }
    langSel.value = S.lang; applyI18N();
    langSel.addEventListener('change', () => {
      S.lang = langSel.value;
      localStorage.setItem('lang', S.lang);

      applyI18N();                 // æ› UI æ–‡æ¡ˆï¼ˆæŒ‰éˆ•/æ¨™é¡Œç­‰ï¼‰
      rebuildCupList();            // é‡å»ºæ¡®å¡ç‰‡ï¼ˆåç¨±è·Ÿè‘—æ›èªè¨€ï¼‰
      syncPreviewsAndResult();     // ç¥ˆç¦±é è¦½ & çµæœåœ–ï¼ˆå« altï¼‰åŒæ­¥
      buildPrayerText();           // ç¥ˆç¦±æ–‡æ›èªè¨€
      buildResultLines(lastOutcome); // çµæœå€æ–‡æ¡ˆæ›èªè¨€
      updateMuteUI();  // è®“ã€ŒéœéŸ³/é–‹è²éŸ³ã€æ–‡å­—è·Ÿè‘—èªè¨€åˆ‡æ›
    });

    // ===== Global Muteï¼ˆå« BGM + SFXï¼‰=====
  let audioMuted = JSON.parse(localStorage.getItem('audioMuted') || 'false');

  function updateMuteUI(){
    const t = I18N[S.lang] || {};
    $('#btnMute').textContent = audioMuted ? (t.muteAllOn || 'ğŸ”‡å…¨éƒ¨éœéŸ³')
                                           : (t.muteAllOff || 'ğŸ”ˆé–‹å•Ÿè²éŸ³');
    $('#btnMute').setAttribute('aria-pressed', String(audioMuted));
  }

  function setAudioMuted(muted){
    audioMuted = !!muted;
    localStorage.setItem('audioMuted', JSON.stringify(audioMuted));
    updateMuteUI();

    // é—œé–‰æ™‚ç«‹åˆ»åœ BGMï¼›é–‹å•Ÿæ™‚è‹¥æœ‰é¸æ“‡å‰‡æ¢å¾©æ’­æ”¾
    if (audioMuted) {
      stopBgm({ fadeOut:false });
    } else {
      const want = currentBgmId || $('#bgmSel')?.value;
      if (want) playBgm(want);
    }
  }

    // ===== SFX =====
    const SFX = {
      toss: 'assets/sounds/toss.ogg',
      ok:   'assets/sounds/ok.ogg',
      bad:  'assets/sounds/bad.ogg',
      meh:  'assets/sounds/meh.ogg',
      select: 'assets/sounds/select.ogg'
    };

  function playSfx(name){
    if (audioMuted) return;                 // ğŸ”• å…¨åŸŸéœéŸ³ï¼šä¸æ’­
    const src = SFX[name]; if(!src) return;

    // ä¾ä¸åŒéŸ³æ•ˆçµ¦ä¸åŒ duck æ™‚é•·ï¼ˆå¯å†å¾®èª¿ï¼‰
    const duckMs = (name === 'toss') ? 900 : 600;
    duckBgm(0.22, duckMs);

    try {
      const a = new Audio(src);
      a.muted = false;                      // æ˜ç¢ºä¸éœéŸ³ï¼ˆäº¤ç”± audioMuted æ§åˆ¶ï¼‰
      a.volume = 1.0;
      a.play().catch(()=>{});
    } catch(e){}
  }

    // ===== BGM duck/unduckï¼ˆæŠ•æ“²èˆ‡çµæœæ™‚å£“ä½éŸ³é‡ï¼Œå®Œäº†å†æ‹‰å›ï¼‰ =====
    let _duckTimer = null;
    let _bgmPrevVol = 0.5; // ä½ çš„é è¨­éŸ³é‡ï¼ˆè¦‹ playBgm è£¡ï¼‰

  function duckBgm(toVol = 0.22, holdMs = 800){
    if (audioMuted) return;                 // ğŸ”• éœéŸ³æ™‚ä¸è¦å‹• BGM
    if (!bgmAudio) return;
    if (_duckTimer === null) _bgmPrevVol = bgmAudio.volume;
    bgmAudio.volume = Math.max(0, Math.min(1, toVol));
    clearTimeout(_duckTimer);
    _duckTimer = setTimeout(()=>{
      if (bgmAudio) bgmAudio.volume = _bgmPrevVol;
      _duckTimer = null;
    }, holdMs);
  }

    // ===== èƒŒæ™¯éŸ³æ¨‚ï¼ˆé¦–é å¯åˆ‡æ›ï¼‰ =====
    let bgmAudio = null;
    let bgmMuted = false;
    let currentBgmId = null;

  function playBgm(id){
    if (!id) return;
    currentBgmId = id;

    // ğŸ”• å…¨åŸŸéœéŸ³ï¼šç›´æ¥ä¸æ’­ï¼Œä¿æŒ state å³å¯
    if (audioMuted) return;

    stopBgm({fadeOut:false});
    const src = `assets/sounds/${id}.ogg`;
    bgmAudio = new Audio(src);
    bgmAudio.loop = true;
    bgmAudio.muted = false;
    bgmAudio.volume = 0.5;
    bgmAudio.play().catch(()=>{});
  }

    function stopBgm({fadeOut=true} = {}){
      if (!bgmAudio) return;
      if (!fadeOut){
        bgmAudio.pause();
        bgmAudio = null;
        currentBgmId = null;
        return;
      }
      const a = bgmAudio;
      const fade = setInterval(()=>{
        if (!a) { clearInterval(fade); return; }
        a.volume = Math.max(0, a.volume - 0.05);
        if (a.volume <= 0.01){
          clearInterval(fade);
          a.pause();
          if (bgmAudio === a) {
            bgmAudio = null;
            currentBgmId = null;
          }
        }
      }, 100);
    }

    // Mute éˆ•
    $('#btnMute').addEventListener('click', ()=>{
      setAudioMuted(!audioMuted);
    });

    // ä¸‹æ‹‰åˆ‡æ›
    const bgmSel = $('#bgmSel');
    bgmSel.addEventListener('change', ()=>{
      const id = bgmSel.value;
      playBgm(id);
    });

    // åˆå§‹åŒ–ï¼šè‡ªå‹•æ’­æ”¾é è¨­ bg_01ï¼ˆå¾…ä½¿ç”¨è€…äº’å‹•å¾Œï¼Œä¸”æœªéœéŸ³ï¼‰
    document.body.addEventListener('click', ()=>{
      if (!bgmAudio && !audioMuted) playBgm('bg_01');
    }, { once: true });

    // ===== setup helpers =====
    function getRadio(name){ return (document.querySelector(`input[name="${name}"]:checked`)||{}).value; }
    function readSetup(){
      const whoType = getRadio('who');
      const whoName = (whoType==='god')? $('#whoName').value.trim() : (whoType==='ancestor')? $('#ancName').value.trim() : '';
      return {
        whoType, whoName,
        player: $('#player').value.trim() || 'ç©å®¶',
        wish:   $('#wish').value.trim() || 'ï¼ˆæœªè¼¸å…¥ï¼‰',
        cup:    S.cup
      }
    }
    function buildPrayerText(){
      const t = I18N[S.lang]; const s = readSetup();
      const who =
        s.whoType==='god'      ? (s.whoName || (S.lang==='tl'?'æŸå°Šç¥æ˜': S.lang==='en'?'a deity':'æŸå°Šç¥æ˜')) :
        s.whoType==='ancestor' ? (s.whoName || (S.lang==='tl'?'æŸä½ç¥–å…ˆ': S.lang==='en'?'an ancestor':'æŸmÃ­ç¥–å…ˆ')) :
                                  (S.lang==='tl'?'å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡' : S.lang==='en'?'the universe and unseen forces':'å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡');

      let line;
      if (S.lang==='tl'){
        line = `ğŸ™${who}ğŸ™ï¼Œä¿¡å¾’${s.player}è™”èª ç¥ˆæ±‚ï¼Œç‚ºè‘—ã€Œ${s.wish}ã€è«‹ç¤ºæŒ‡æ•™ã€‚`;
      } else if (S.lang==='en'){
        line = `Dear ${who}, I (${s.player}) sincerely ask for guidance regarding: â€œ${s.wish}â€.`;
      } else { // zh
        line = `${who}åœ¨ä¸Šï¼Œä¿¡å¾’ï¼ˆ${s.player}ï¼‰èª å¿ƒç¥ˆæ±‚ï¼Œç‚ºã€Œ${s.wish}ã€è«‹ç¤ºæŒ‡å¼•ã€‚`;
      }
      $('#prayText').textContent = line;
    }

    function cupLabel(c){
      if (c && typeof c.name === 'object') {
        return c.name[S.lang] || c.name.tl || c.name.en || c.name.zh || Object.values(c.name)[0];
      }
      return c?.name || '';
    }

    // ===== build cup list =====
    const cupList = $('#cupList');

  function rebuildCupList(){
    cupList.innerHTML = '';
    CUPS.forEach(c=>{
      const btn = document.createElement('button');
      btn.className='card';
      btn.type='button';
      btn.setAttribute('role','option');
      btn.setAttribute('aria-pressed', c.id===S.cup?'true':'false');
      btn.dataset.id = c.id;

      // æ®¼ï¼šthumb + labelï¼ˆthumb å…ˆæ”¾ç©ºï¼Œå†ç”¨ renderCupInto å¡å…¥ï¼‰
      btn.innerHTML = `<div class="thumb"></div><span class="label">${cupLabel(c)}</span>`;
      const th = btn.querySelector('.thumb');
      renderCupInto(th, c, 'yang');

      btn.addEventListener('click',()=>{
        playSfx('select');
        S.cup = c.id;
        $$('.card').forEach(x=>x.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');

        const cup = CUPS.find(x=>x.id===S.cup)||CUPS[0];
        renderCupInto($('#previewL'), cup, 'yang');
        renderCupInto($('#previewR'), cup, 'yin');
      });
      cupList.appendChild(btn);
    });
  }

    function ensureResultHolders(){
      const box = document.querySelector('#page-result .dice') || document.getElementById('page-result');
      if (!box) return;
      if (!document.getElementById('resL')) {
        const dl = document.createElement('div'); dl.id = 'resL'; dl.className = 'cup';
        box.appendChild(dl);
      }
      if (!document.getElementById('resR')) {
        const dr = document.createElement('div'); dr.id = 'resR'; dr.className = 'cup';
        box.appendChild(dr);
      }
    }

    // ===== å®‰å…¨æ¸²æŸ“æ¯å­ï¼šæ”¯æ´ HTML æˆ– URL =====
  function renderCupInto(el, cup, side){
    if (!el || !cup) return;
    const out = cup.render(side);
    // å¦‚æœæ˜¯ HTML ç‰‡æ®µ
    if (typeof out === 'string' && out.trim().startsWith('<')){
      el.innerHTML = out;
    } else {
      // å¦‚æœæ˜¯ç´”ç¶²å€æˆ–å…¶ä»–å‹å¼ â†’ å»ºç«‹ <img>
      el.innerHTML = '';
      const img = document.createElement('img');
      img.src = String(out);
      img.alt = `${cupLabel(cup)} - ${side}`;
      img.decoding = 'async';
      img.loading = 'eager';
      el.appendChild(img);
    }
  }

  function syncPreviewsAndResult(){
    const cup = CUPS.find(c => c.id === S.cup) || CUPS[0];

    // ç¥ˆç¦±é å…©é¡†é è¦½
    const pl = $('#previewL'), pr = $('#previewR');
    if (pl && pr && cup) {
      renderCupInto(pl, cup, 'yang');
      renderCupInto(pr, cup, 'yin');
    }

    // çµæœé ï¼ˆè‹¥å·²é¡¯ç¤ºï¼‰
    if (!$('#page-result').hidden && lastOutcome && cup) {
      const l = $('#resL'), r = $('#resR');
      if (l) renderCupInto(l, cup, lastOutcome.L);
      if (r) renderCupInto(r, cup, lastOutcome.R);
    }
  }

  function renderPrayPreviews(){
    const cup = CUPS.find(c => c.id === S.cup) || CUPS[0];
    const pl = $('#previewL'), pr = $('#previewR');
    if (pl && pr && cup) {
      renderCupInto(pl, cup, 'yang');
      renderCupInto(pr, cup, 'yin');
    }
  }

  // æŠ•æ“² â†’ å…ˆå½ˆè·³(.cup) â†’ ç™¼å…‰+å·¦å³æ“ºå‹• â†’ è¼•æ™ƒæ”¶å°¾
  function applyTossAndShake(el, type){
    const cup = el.closest('.cup') || el;

    // å…ˆæ¸…ä¹¾æ·¨ï¼Œé¿å…æ®˜ç•™å°è‡´é‡æ’­
    [el, cup].forEach(x => x && x.classList.remove('toss','bounce','sway','shake','glow'));
    void el.offsetWidth; // reflow

    const TOSS_MS   = 900;  // .toss 0.9s
    const BOUNCE_MS = 800;  // .bounceStrong 0.8s
    const SWAY_MS   = 1100; // .sway 1.1s
    const SHAKE_MS  = 600;  // .shake 0.6s

    // 1) æŠ•æ“²
    el.classList.add('toss');

    setTimeout(() => {
      el.classList.remove('toss');

      // 2) å…ˆå½ˆï¼ˆåªå¥—åœ¨ .cupï¼‰
      cup.classList.add('bounce');

      setTimeout(() => {
        // ğŸ‘‰ å½ˆè·³çµæŸç«‹åˆ»æ‹”æ‰ï¼Œé¿å…ä¹‹å¾Œåˆè¢«è§¸ç™¼
        cup.classList.remove('bounce');

        // 3) ç™¼å…‰ + å·¦å³æ“º
        if (type) el.dataset.outcome = type; // ok / bad / meh
        el.classList.add('glow','sway');

        setTimeout(() => {
          // 4) è¼•æ™ƒæ”¶å°¾
          el.classList.remove('sway');
          el.classList.add('shake');

          setTimeout(() => {
            // 5) æ¸…ç†
            el.classList.remove('shake','glow');
            delete el.dataset.outcome;
          }, SHAKE_MS);
        }, SWAY_MS);
      }, BOUNCE_MS);
    }, TOSS_MS);
  }

    // ===== misc utils =====
  const hist = [];
  function historyPush(type){ hist.push(type); if(hist.length>9) hist.shift(); }
  function checkStreak(seq){
    if(hist.length < seq.length) return false;
    const n = seq.length;
    for(let i=0;i<=hist.length-n;i++){
      if(seq.every((v,k)=>hist[i+k]===v)) return true;
    }
    return false;
  }
  function resetStreak(){ hist.length = 0; }   // âœ… é‡ç½®å½©è›‹
  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

  // å°å·¥å…·ï¼šæŠŠçµæœé çš„ UI ä¸€èµ·æ¸…ä¹¾æ·¨
  function clearResultUI(){
    $('#resLines')?.replaceChildren();
    const badge = $('#badge');
    if (badge){ badge.className = 'badge'; badge.textContent = ''; }
    $('#resL')?.replaceChildren();
    $('#resR')?.replaceChildren();
  }

  // ===== navigationï¼ˆHash è·¯ç”±ï¼šå››æ­¥æµç¨‹ï¼‰=====
  const PAGES = ['setup1','setup2','pray','result'];

  function show(page){
    PAGES.forEach(p=>{
      const el = document.getElementById('page-'+p);
      if (el) el.hidden = (p !== page);
    });

    // å·¥å…·åˆ—æŒ‰éˆ•é¡¯ç¤ºè¦å‰‡
    const onSetup1 = page === 'setup1';
    const onSetup2 = page === 'setup2';
    const onPray   = page === 'pray';
    const onResult = page === 'result';

    // èªè¨€é¸å–®åªåœ¨ Step 1 é¡¯ç¤º
    document.querySelector('.lang')?.toggleAttribute('hidden', !onSetup1);

    // èƒŒæ™¯éŸ³æ•ˆæŒ‰éˆ•åªåœ¨ Step 1 & Step 2 é¡¯ç¤º
    document.getElementById('btnMute')
      ?.toggleAttribute('hidden', !(onSetup1 || onSetup2));

    $('#btnNext').hidden  = !(onSetup1 || onSetup2);  // [ä¸‹ä¸€æ­¥]ï¼šåªåœ¨ Step1 & Step2 é¡¯ç¤º
    $('#btnBack').hidden  = onSetup1;  // [å›è¨­å®š]ï¼šé™¤äº† Step1 ä»¥å¤–éƒ½é¡¯ç¤º
    $('#btnToss').hidden  = !onPray;  // [è·‹æ¡®]ï¼šåªåœ¨ç¥ˆç¦±é é¡¯ç¤º
    $('#btnAgain').hidden = !onResult;   // [å†è·‹ä¸€æ“º]ï¼šåªåœ¨çµæœé é¡¯ç¤º

    document.body.classList.toggle('is-result', onResult);
    window.scrollTo({ top: 0, behavior: 'smooth' });

    if (onPray){ buildPrayerText(); renderPrayPreviews(); }
    if (onResult){
      ensureResultHolders();
      _updateResultMinHeight();
    }
  }

  function currentPageFromHash(){
    const h = (location.hash || '').replace(/^#\//,'').trim();
    return PAGES.includes(h) ? h : 'setup1';
  }
  function goto(page){ location.hash = '#/' + (PAGES.includes(page)?page:'setup1'); }

  if (!location.hash) location.hash = '#/setup1';
  window.addEventListener('hashchange', ()=>{
    const p = currentPageFromHash();
    show(p);
    // âœ… è‹¥æ˜¯ç›´æ¥é€²åˆ° Step2ï¼ˆè€Œä¸”ä¹‹å‰æœ‰ä¸Ÿéä¸€æ¬¡ï¼‰ï¼Œä¹Ÿé‡ç½® + æ¸… UI
    if (p === 'setup2' && ($('#badge')?.textContent || $('#resLines')?.children?.length)) {
      resetStreak();
      clearResultUI();
    }
  });
  show(currentPageFromHash());

  // ===== buttonsï¼ˆä¾ç›®å‰é é¢æµå‘ä¸‹ä¸€æ­¥ï¼‰=====
  $('#btnNext').addEventListener('click', ()=>{
    const cur = currentPageFromHash();
    if (cur === 'setup1') {
      goto('setup2');               // Step1 -> Step2
    } else if (cur === 'setup2') {
      buildPrayerText();
      renderPrayPreviews();
      goto('pray');                 // Step2 -> Step3
    }
  });

  $('#btnBack').addEventListener('click', ()=>{
    const cur = currentPageFromHash();
    if (cur === 'setup2') {
      goto('setup1');                      // Step2 -> Step1
    } else if (cur === 'pray' || cur === 'result') {
      // âœ… åªæœ‰å¾ç¥ˆç¦±/çµæœé å›åˆ° Step2 æ‰é‡ç½®å½©è›‹ + æ¸… UI
      resetStreak();
      clearResultUI();
      goto('setup2');                      // å›åˆ°é¸æ¡®é 
    }
  });

  // æ–°ç‰ˆï¼šå…ˆå¾®éœ‡ + å»¶é² 1 ç§’ï¼Œå†é€²çµæœé èˆ‡ toss()
  $('#btnToss').addEventListener('click', ()=>{
    // 2) å¾®éœ‡æ„Ÿï¼ˆæ”¯æ´å°±éœ‡ 60msï¼‰
    try { if (navigator.vibrate) navigator.vibrate(60); } catch(_) {}

    // é˜²é€£é»ï¼šæš«æ™‚ç¦ç”¨ 1.4 ç§’
    const btn = $('#btnToss');
    btn.disabled = true;
    setTimeout(()=>{ btn.disabled = false; }, 1400);

    setTimeout(()=>{
      goto('result');
      const res = document.getElementById('page-result');
      res.classList.remove('show');   // å…ˆç§»é™¤èˆŠå‹•ç•«
      void res.offsetWidth;           // é‡æ–°è§¸ç™¼ transition
      res.classList.add('show');      // åŠ å…¥æ·¡å…¥æ•ˆæœ

      $('#previewL').innerHTML = '';
      $('#previewR').innerHTML = '';
      ensureResultHolders();
      toss();
    }, 1000);
  });

  $('#btnAgain').addEventListener('click', ()=>{
    goto('pray');            // å›åˆ°ç¥ˆç¦±é 
    // show('pray') æœƒè‡ªå‹• buildPrayerText() + renderPrayPreviews()
  });

    // ===== toss logic =====
  function toss(){
    playSfx('toss');
    const sides = ['yin','yang'];
    const L = sides[Math.random()<0.5?0:1];
    const R = sides[Math.random()<0.5?0:1];
    let type;
    if((L==='yin' && R==='yang') || (L==='yang' && R==='yin')) type='ok';
    else if(L==='yang' && R==='yang') type='bad';
    else type='meh';
    lastOutcome = {L,R,type};

    const cup = CUPS.find(c => c.id === S.cup) || CUPS[0];
    const l = $('#resL'), r = $('#resR');
    if (l) renderCupInto(l, cup, lastOutcome.L);
    if (r) renderCupInto(r, cup, lastOutcome.R);

    if (l) applyTossAndShake(l, type);
    if (r) applyTossAndShake(r, type);

    const t = I18N[S.lang];
    const badge = $('#badge');
    if (badge) {
      badge.className = 'badge ' + (type==='ok'?'ok': type==='bad'?'bad':'meh');
      badge.textContent = type==='ok'? t.ok : type==='bad'? t.bad : t.meh;
    }

    buildResultLines(lastOutcome);
    setTimeout(()=> playSfx(type), 120);
  }

    // ===== result lines =====
    function buildResultLines(outcome){
      const t = I18N[S.lang]; const s = readSetup(); if(!outcome) return;
      const who = s.whoType==='god' ? (s.whoName|| (S.lang==='tl'?'æŸä½ç¥æ˜':'æŸä½ç¥æ˜'))
                : s.whoType==='ancestor'? (s.whoName|| (S.lang==='tl'?'æŸä½ç¥–å…ˆ':'æŸä½ç¥–å…ˆ'))
                : (S.lang==='tl'?'å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡':'å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡');
      const box = $('#resLines'); box.innerHTML='';
      const add = (label, text)=>{ const d = document.importNode($('#tpl-line').content,true); d.querySelector('div').innerHTML = `<b>${label}ï¼š</b> ${escapeHtml(text)}`; box.appendChild(d); };
      add(t.who, who);
      add(t.you, s.player);
      add(t.topic, s.wish);
      // å½©è›‹ï¼šåµæ¸¬ä¸‰é€£ç™¼
      historyPush(outcome.type);
      const tStreak = I18N[S.lang]?.streak;

      const eggBox = document.createElement('div');
      eggBox.className = 'small';

      if (checkStreak(['ok','ok','ok']) && tStreak?.ok) {
        eggBox.innerHTML = tStreak.ok;
        box.appendChild(eggBox);
      } else if (checkStreak(['bad','bad','bad']) && tStreak?.bad) {
        eggBox.innerHTML = tStreak.bad;
        box.appendChild(eggBox);
      } else if (checkStreak(['meh','meh','meh']) && tStreak?.meh) {
        eggBox.innerHTML = tStreak.meh;
        box.appendChild(eggBox);
      }

      // === æ·¡å…¥é¡¯ç¤ºå½©è›‹ ===
      if (box.querySelector('.small')) {
        const egg = box.querySelector('.small:last-child');
        requestAnimationFrame(() => egg.classList.add('show'));
      }
    }

  function _updateResultMinHeight(){
    const res = document.getElementById('page-result');
    if (!res) return;
    const header = document.querySelector('header')?.offsetHeight || 64;
    const toolbar = document.querySelector('.toolbar')?.offsetHeight || 72;
    const mainPad = 16 * 2; // main ä¸Šä¸‹ padding åˆè¨ˆï¼ˆä½ ç¾åœ¨æ˜¯ 16pxï¼‰
    const h = Math.max(280, window.innerHeight - (header + toolbar + mainPad));
    res.style.minHeight = h + 'px';
  }

  // é€²åˆ°çµæœé æ™‚ç®—ä¸€æ¬¡ï¼›æ—‹è½‰/ç¸®æ”¾ä¹Ÿé‡ç®—
  window.addEventListener('resize', _updateResultMinHeight);
  window.addEventListener('orientationchange', _updateResultMinHeight);

    // ===== å¯æ‘ºç–Š fieldsetï¼ˆè‡ªå‹•å¥—ç”¨åˆ°è¨­å®šé ï¼‰ =====
  function makeFieldsetFoldable(fs, {open=false, storageKey} = {}){
    if (!fs || fs.classList.contains('folded-ready')) return;
    fs.classList.add('fold','folded-ready');

    // è®€å–å„²å­˜ç‹€æ…‹ï¼ˆå„ªå…ˆæ–¼ open åƒæ•¸ï¼‰
    const key = storageKey || `fold:${fs.id || fs.querySelector('legend')?.textContent || 'unnamed'}`;
    const saved = localStorage.getItem(key);
    const shouldOpen = saved ? (saved === '1') : !!open;

    // å–å‡º legendï¼Œå…¶é¤˜å­©å­åŒ…æˆå…§å®¹å€
    const legend = fs.querySelector('legend') || fs.insertAdjacentElement('afterbegin', document.createElement('legend'));
    const content = document.createElement('div');
    content.className = 'fold-content';
    while (legend.nextSibling) content.appendChild(legend.nextSibling); // å…¨éƒ¨ç§»å…¥
    fs.appendChild(content);

    // é‡æ–°çµ„ legendï¼šæ–‡å­— + caret
    const textSpan = document.createElement('span');
    textSpan.className = 'legend-text';
    textSpan.textContent = legend.textContent.trim() || 'å…§å®¹';
    legend.textContent = '';
    legend.appendChild(textSpan);

    const caret = document.createElement('i');
    caret.className = 'caret';
    legend.appendChild(caret);

    // å¯é»æ“Šåˆ‡æ›
    fs.setAttribute('aria-expanded', shouldOpen ? 'true':'false');
    if (shouldOpen){
      // å…ˆè®“å®ƒèƒ½å±•é–‹åˆ°åˆé©é«˜åº¦ï¼ˆå…ˆç®—å…§å®¹é«˜åº¦ï¼‰
      requestAnimationFrame(()=>{ fs.setAttribute('aria-expanded','true'); });
    }

    legend.addEventListener('click', ()=>{
      const openNow = fs.getAttribute('aria-expanded') === 'true';
      fs.setAttribute('aria-expanded', openNow ? 'false' : 'true');
      localStorage.setItem(key, openNow ? '0' : '1');
    });
  }

  // æŠŠè¨­å®šé çš„ä¸‰å€‹å€å¡Šè®Šæˆå¯æ‘ºç–Š
  function setupAccordion(){
    // ä½ ç¾åœ¨çš„è¨­å®šé æœ‰ä¸‰å¡Šï¼šæ±‚å•å°è±¡ / åŸºæœ¬è³‡æ–™ / æ¡®æ¨£å¼
    // ä¾å¯¦éš› fieldset é †åºè‡ªå‹•å¥—ç”¨ï¼šç¬¬ 1 å¡Šå±•é–‹ï¼Œå…¶é¤˜æ”¶åˆ
    // åŸï¼š'#page-setup fieldset'
    const sets = Array.from(document.querySelectorAll('#page-setup1 fieldset'));
    sets.forEach((fs, idx)=>{
      makeFieldsetFoldable(fs, { open: idx === 0, storageKey: `poah:fold:${idx}` });
    });
  }

    // ===== init =====
    rebuildCupList();     // å…ˆæŠŠå¡ç‰‡ç•«å‡ºä¾†
    setupAccordion();     // å†æŠŠè¨­å®šé ä¸‰å€‹å€å¡Šæ›ä¸Šæ‘ºç–Šè¡Œç‚º
    show('setup1');        // é€²å…¥è¨­å®šé 
    $$('input[name="who"]').forEach(r=>{
      r.addEventListener('change',()=>{
        const v = getRadio('who'); S.whoType=v;
        $('#whoName').disabled = v!=='god';
        $('#ancName').disabled = v!=='ancestor';
      });
    });
    $('#whoName').disabled=false; $('#ancName').disabled=true;

    // Keyboard: press Enter/Space to toss on pray page
    document.addEventListener('keydown',(e)=>{
      if(!$('#page-pray').hidden && (e.key==='Enter'||e.key===' ')){ e.preventDefault(); $('#btnToss').click(); }
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // é€™è£¡å¯ä»¥æ›æˆè‡ªè¨‚ UIï¼›ç°¡å–®åšå°±ç›´æ¥ reload
        window.location.reload();
      });
      navigator.serviceWorker.getRegistration().then((reg) => {
        if (!reg) return;
        if (reg.waiting) reg.waiting.postMessage('SKIP_WAITING');
        reg.addEventListener('updatefound', () => {
          const sw = reg.installing;
          if (!sw) return;
          sw.addEventListener('statechange', () => {
            if (sw.state === 'installed' && reg.waiting) {
              reg.waiting.postMessage('SKIP_WAITING');
            }
          });
        });
      });
    }
  </script>
  <script>
    (function () {
      // å¦‚æœä½ ä¿ç•™æ•´é æ»¾å‹•ï¼Œå°±ç›£è½ windowï¼›å¦‚æœä½ æŠŠæ»¾å‹•é™å®šåœ¨ mainï¼Œå°±æ”¹æˆ const SCROLLER = document.querySelector('main');
      const SCROLLER = window;

      let startY = 0;

      // è¨˜éŒ„æ‰‹æŒ‡èµ·å§‹ Y
      window.addEventListener('touchstart', (e) => {
        const t = e.touches && e.touches[0];
        if (!t) return;
        startY = t.clientY;
      }, { passive: true });

      // åœ¨ã€Œå·²ç¶“åœ¨é ‚ç«¯ã€ä¸”ã€Œæ‰‹æŒ‡å¾€ä¸‹æ‹‰ã€æ™‚ï¼Œé˜»æ­¢é è¨­ï¼ˆé¿å… iOS æ©¡çš®ç­‹ & PWA ç©ºç™½ï¼‰
      window.addEventListener('touchmove', (e) => {
        const t = e.touches && e.touches[0];
        if (!t) return;

        // ç•¶å‰æ»¾å‹•ä½ç½®ï¼ˆæ•´é æ™‚ç”¨ window.scrollYï¼›å¦‚æœ main æ˜¯æ»¾å‹•å®¹å™¨ï¼Œå°±æ”¹ç”¨ main.scrollTopï¼‰
        const scrollTop = (SCROLLER === window)
          ? window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0
          : SCROLLER.scrollTop;

        const deltaY = t.clientY - startY;   // å¾€ä¸‹æ‹‰æ™‚ç‚ºæ­£å€¼

        if (scrollTop <= 0 && deltaY > 0) {
          // åœ¨é ‚ç«¯åˆå¾€ä¸‹æ‹‰ â†’ é˜»æ­¢é è¨­ï¼Œé¿å…è§¸ç™¼ç€è¦½å™¨æ©¡çš®ç­‹/åˆ·æ–°
          e.preventDefault();
        }
      }, { passive: false });
    })();
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    });
  }
  </script>
</body>
</html>
