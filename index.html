<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>è·‹æ¡®å•¦ï¼ PoaÌh-poe--lah!</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0f">
<style>
/* ===== åŸºæœ¬è®Šæ•¸èˆ‡å…¨åŸŸæ¨£å¼ ===== */
:root{
  --bg:#0b0b0f; --fg:#f2f4f8; --muted:#b9bcc6; --acc:#ffd452; --card:#141822; --glass:rgba(255,255,255,.06);
  --ok:#4caf50; --bad:#ef5350; --meh:#ffb020;
  --result-lift:64px; /* çµæœé ä¸Šç§»é‡ï¼ˆå¯èª¿ï¼‰ */
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  color:var(--fg);
  background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
}
main{ max-width:680px; margin:0 auto; padding:16px 16px 72px; }

header{
  position:sticky; top:0; z-index:10;
  background:linear-gradient(180deg,#0b0b0f 70%,#0b0b0f00);
  padding:12px 16px; display:flex; gap:8px; align-items:center;
}
h1{ font-size:22px; margin:0 8px 0 0; }
.lang{ margin-left:auto; }

/* è¡¨å–®å…ƒä»¶ï¼ˆç»ç’ƒæ„ŸåŠé€æ˜ï¼‰ */
select,input,textarea,button{
  width:100%; padding:9px 10px; font-size:14px; border-radius:10px;
  color:var(--fg);
  background:rgba(15,19,32,.55);
  border:1px solid rgba(32,36,55,.6);
  -webkit-backdrop-filter:blur(4px); backdrop-filter:blur(4px);
}
textarea{ min-height:70px; resize:vertical }

/* fieldset / å¡ç‰‡ / ç¥ˆç¦±æ–‡ï¼šåŒæ­¥åŠé€æ˜ */
fieldset,.card,.prayer{
  background:rgba(15,20,34,.55);
  border:1px solid rgba(31,36,53,.7);
  -webkit-backdrop-filter:blur(4px); backdrop-filter:blur(4px);
}
legend{ padding:0 8px; color:#d6daea; }
.row{ display:grid; grid-template-columns:1fr; gap:12px; }

/* ===== æ¡®æ¨£å¼å¡ç‰‡ï¼ˆæ¯›ç»ç’ƒåŠé€æ˜é¢¨æ ¼ï¼‰ ===== */
.cards {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.card {
  border: 1px solid rgba(255, 255, 255, 0.15);
  background: rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  padding: 10px;
  cursor: pointer;
  outline: none;
  position: relative;
  -webkit-backdrop-filter: blur(6px) saturate(130%);
  backdrop-filter: blur(6px) saturate(130%);
  transition: all 0.25s ease;
}

/* å¡ç‰‡å€ï¼šæ›´é€æ˜ã€è®“åº•åœ–é€å‡ºä¾† */
.cards .card {
  border: 1px solid rgba(255, 255, 255, 0.12);
  background: rgba(255, 255, 255, 0.05);
  border-radius: 16px;
  padding: 10px;
  cursor: pointer;
  outline: none;
  position: relative;
  -webkit-backdrop-filter: blur(5px) saturate(130%);
  backdrop-filter: blur(5px) saturate(130%);
  transition: all 0.25s ease;
}
.cards .card[aria-pressed="true"],
.cards .card:focus {
  box-shadow: 0 0 0 2px var(--acc) inset;
  background: rgba(255, 255, 255, 0.12);
}

.thumb {
  background: rgba(255, 255, 255, 0.12);
  border-radius: 12px;
  -webkit-backdrop-filter: blur(3px);
  backdrop-filter: blur(3px);
}

.card[aria-pressed="true"], .card:focus{
  box-shadow:0 0 0 2px var(--acc) inset;
  background:rgba(255,255,255,.15);
}
.thumb{
  background:rgba(255,255,255,.12);
  border-radius:12px;
  -webkit-backdrop-filter:blur(3px); backdrop-filter:blur(3px);
}
/* å¡ç‰‡ç”¨çš„ label èˆ‡ æ¡®åº•ä¸‹åç¨±åˆ†æµï¼Œé¿å…äº’æ¶ */
.cards .label{
  display:block; text-align:center; margin-top:6px; font-size:13px; color:#f2f4f8;
  text-shadow:0 1px 2px rgba(0,0,0,.4);
}

/* å·¥å…·åˆ— */
.toolbar{
  position:fixed; left:0; right:0; bottom:0;
  background:linear-gradient(180deg,transparent,rgba(0,0,0,.25)),#0b0b0f;
  padding:12px 16px; display:flex; gap:12px; z-index:20;
}
.btn{ background:#1a2140; border:1px solid #232a52; color:#fff; padding:12px 14px; border-radius:14px; font-size:16px; }
.btn.primary{ background:linear-gradient(180deg,#2a3568,#1f2852); border-color:#3b4aa8; }
.btn.ghost{ background:#0f1320; }

.center{ display:grid; place-items:center; }
.prayer{ line-height:1.7; color:#dfe3f3; border-style:dashed; border-radius:16px; padding:14px; }
.result{ display:grid; gap:12px; }

/* æ¡®é¡¯ç¤ºå€ */
.dice{ display:flex; justify-content:center; gap:28px; margin:8px 0 16px; }

/* ===== æ¡®å°ºå¯¸ï¼šä¾è¢å¹•è‡ªé©æ‡‰ï¼Œä¸¦å…è¨±è·³å‡ºç¯„åœ ===== */
.cup{
  position: relative;           /* è®“å®¹å™¨å¯ç•¶ä½ç§»åƒè€ƒé» */
  overflow: visible;            /* âœ¨ å½ˆè·³æ™‚ä¸è¢«å‰ªè£ */
  width: clamp(96px, 30vw, 140px);
  height: clamp(96px, 30vw, 140px);
  display: grid;                /* ç½®ä¸­å…§éƒ¨æ¡®åœ– */
  place-items: center;
}
/* é™åˆ¶æ¡®å…§åœ–å½¢å¤§å°ï¼Œé¿å…è¢«æ’æ»¿å®¹å™¨ */
.cup img,
.cup svg {
  max-width: 85%;
  max-height: 85%;
  width: auto;
  height: auto;
  object-fit: contain; /* ä¿æŒæ¯”ä¾‹ä¸è£åˆ‡ */
}
@media (max-width:480px), (max-height:740px){
  .cup{
    width: clamp(88px, 28vh, 132px);
    height: clamp(88px, 28vh, 132px);
  }
}

/* æ¼‚æµ®èˆ‡æŠ•æ“²å‹•ç•« */
.float{ animation:float 2s ease-in-out infinite; }
@keyframes float{ 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }
.toss{ animation:toss .9s cubic-bezier(.2,.8,.2,1); }
@keyframes toss{
  0%{ transform:translateY(-20vh) rotate(-40deg); opacity:.7 }
  60%{ transform:translateY(0) rotate(0) }
  80%{ transform:translateY(-5px) }
  100%{ transform:translateY(0); opacity:1 }
}
/* ===== åŠ å¼·ç‰ˆå½ˆåœ°æ•ˆæœï¼ˆå½ˆé«˜ä¸€é»ï¼‰ ===== */
.bounce {
  animation: bounceStrong 0.8s cubic-bezier(.25, .65, .35, 1.3); /* è¼ƒé•·ã€å½ˆæ€§å¼· */
}

@keyframes bounceStrong {
  0%   { transform: translateY(0); }
  20%  { transform: translateY(20px); }   /* ä¸‹å¢œ */
  40%  { transform: translateY(-24px); }  /* é«˜å½ˆèµ· */
  55%  { transform: translateY(12px); }   /* å›è½ */
  70%  { transform: translateY(-10px); }  /* å°åå½ˆ */
  85%  { transform: translateY(4px); }
  100% { transform: translateY(0); }
}

/* å·¦å³æ“ºå‹•å¹¾ä¸‹å†åœï¼ˆè‡ªç„¶è½åœ°æ„Ÿï¼‰ */
.sway {
  animation: swayFew 1.1s ease-in-out forwards;
}
@keyframes swayFew {
  0%   { transform: rotate(0deg); }
  10%  { transform: rotate(-10deg); }
  25%  { transform: rotate(10deg); }
  40%  { transform: rotate(-8deg); }
  60%  { transform: rotate(8deg); }
  80%  { transform: rotate(-4deg); }
  100% { transform: rotate(0deg); }
}

/* å¼±å‹•ä½œä½¿ç”¨è€…ï¼šé—œé–‰å‹•æ•ˆ */
@media (prefers-reduced-motion: reduce){
  .sway, .shake, .toss{ animation: none !important; }
}

/* çµæœå¾½ç«  */
.badge{
  display:inline-block;
  padding:.25rem .5rem;
  border-radius:999px;
  font-size:20px;
  border:1px solid #2a3152;
  background:#101424;
  color:#ccd2ea;
  margin-top: 0.8em;   /* âœ… è®“å¾½ç« å¾€ä¸‹å¤šä¸€è¡Œè·é›¢ */
}
.ok{ color:#e8ffe8; border-color:#2f6b3a; background:rgba(76,175,80,.5); }
.bad{ color:#ffecec; border-color:#7b3434; background:rgba(239,83,80,.5); }
.meh{ color:#fff2e0; border-color:#7b5a24; background:rgba(255,176,32,.5); }

.sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
.small{ font-size:12px; color:#aeb6d8; }

/* ===== çµæœé é–“è·ï¼ˆå–®ä¸€å®šç¾©ï¼Œé¿å…é‡è¤‡ï¼‰ ===== */
#page-result h2{ margin:0 0 6px; }
#page-result .dice{ gap:18px; margin:4px 0 8px; }
#page-result .result{ gap:8px; }

/* çµæœå€ï¼šè®“æ¡®èˆ‡æ–‡å­—ä¿æŒç´„å…©è¡Œè·é›¢ï¼ŒåŠ ä¸ŠæŸ”å’Œåº•è‰² */
#resLines{
  background:rgba(0,0,0,.4);
  border-radius:14px;
  padding:10px 12px;
}
/* é—œéµè©ä¿æŒäº®ä¸€é»ï¼ˆä¿ç•™å–®ä¸€ç‰ˆæœ¬ï¼‰ */
#resLines b{ font-weight:600; color:#fff9cc; }

/* ===== é‡‘å…‰ï¼šæ ¹æ“šçµæœæ”¹é¡è‰²ï¼Œå…©æ¬¡æ“´æ•£ ===== */
.glow{ position:relative; z-index:1; }
.glow::after{
  content:""; position:absolute; inset:-40px; border-radius:50%;
  background:radial-gradient(circle, rgba(255,223,100,.55) 0%, rgba(255,223,100,.35) 25%, rgba(255,223,100,.15) 50%, rgba(255,223,100,0) 80%);
  filter:blur(12px); opacity:0; animation:glowTwice 1.4s ease-in-out;
}
@keyframes glowTwice{
  0%,100%{ opacity:0; transform:scale(1) }
  20%{ opacity:.9; transform:scale(1.1) }
  35%{ opacity:0; transform:scale(1) }
  55%{ opacity:.8; transform:scale(1.15) }
  70%{ opacity:0; transform:scale(1) }
}
.glow[data-outcome="bad"]::after{
  background:radial-gradient(circle, rgba(180,180,180,.5) 0%, rgba(160,160,160,.3) 25%, rgba(130,130,130,.1) 50%, rgba(0,0,0,0) 80%);
}
.glow[data-outcome="meh"]::after{
  background:radial-gradient(circle, rgba(255,170,50,.55) 0%, rgba(255,140,30,.35) 25%, rgba(255,110,0,.15) 50%, rgba(255,100,0,0) 80%);
}

/* ===== é¡¯ç¤ºçµæœæ™‚ï¼ŒæŠŠæ•´å¡Šå¾€ä¸Šè²¼è¿‘ä¸Šæ–¹æ–‡å­—ï¼ˆç”¨ --result-lift æ§åˆ¶ï¼‰ ===== */
body.is-result main{ padding-top:4px; }
body.is-result #page-result{ margin-top:calc(-1 * var(--result-lift)); }
body.is-result #page-result h2{ margin:0 0 4px; }
body.is-result #page-result .dice{ gap:14px; margin:0 0 6px; }
body.is-result #page-result .result{ gap:6px; }

/* è¢å¹•è¼ƒå¯¬æ™‚ï¼Œå¯å†å¤šè²¼ä¸€é» */
@media (min-width:480px){ :root{ --result-lift:80px; } }
@media (min-width:768px){ :root{ --result-lift:96px; } }

/* ===== æ‰‹æ©Ÿ App ç‰ˆé¢ç²¾ç°¡ï¼ˆå­—ç´š/é–“è·å£“ä½ï¼‰ ===== */
@media (max-width:480px),(max-height:740px){
  body,main{ font-size:15px; line-height:1.45; }
  main{ padding:8px 12px 72px; max-width:560px; }

  /* ä¿®æ­£é€™è¡ŒåŸæœ¬çš„éŒ¯å­—ï¼ˆå¤šäº†ä¸€å€‹ 18px;ï¼‰ */
  header{ padding:8px 10px; }
  h1{ font-size:18px; margin-right:6px; }

  /* è¡¨å–®å¾®èª¿ */
  select,input,textarea,button{
    background:rgba(15,19,32,.55);
    border:1px solid rgba(32,36,55,.6);
    -webkit-backdrop-filter:blur(4px); backdrop-filter:blur(4px);
  }
  textarea{ min-height:70px; }

  fieldset{ padding:10px; border-radius:12px; }
  legend{ font-size:15px; margin-bottom:4px; }
  label{ font-size:14px; }

  .row{ gap:10px; }
  .cards{ gap:8px; }
  .card{ padding:8px; border-radius:10px; }
  .thumb{ border-radius:8px; }
  .cards .label{ font-size:11.5px; margin-top:3px; }

  .toolbar{ padding:8px 10px; gap:6px; }
  .btn{ padding:8px 10px; font-size:14px; border-radius:10px; }

  /* ç¥ˆç¦±é  */
  #page-pray h2{ margin:0 0 4px; font-size:16px; font-weight:600; opacity:.9; }
  #page-pray .prayer{
    font-size:14px; padding:10px; margin:0 0 6px; line-height:1.5;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }
  #page-pray .dice{ gap:14px; margin:4px 0 8px; }

  /* çµæœé æ›´ç·Šæ¹Š */
  #page-result h2{ margin:0 0 4px; font-size:16px; }
  #page-result .dice{ gap:14px; margin:2px 0 6px; }
  #page-result .result{ gap:6px; }

  /* é€™è¡ŒæŠŠ badge å£“å¤ªå°äº†ï¼Œè«‹åˆªæ‰æˆ–æ”¹å¤§ä¸€é» */
  /* .badge{ font-size:11px; padding:.2rem .5rem; } */

  .small{ font-size:11.5px; }
  body.is-result main{ padding-top:2px; }
  body.is-result #page-result{ margin-top:calc(-1 * var(--result-lift,72px)); }

  /* ç¥ˆç¦±é  BGM é¸æ“‡å€ç·Šæ¹ŠåŒ– */
  #bgmField{ padding:8px 10px; }
  #bgmField legend{ font-size:14px; color:#cfd3e6; }
  #bgmField .row{ gap:6px; }
  #bgmField .row label{ font-size:14px; }
}

/* ===== BGM ä¸‹æ‹‰é¸å–®ï¼ˆheader å³å´ï¼‰ ===== */
.bgm select{
  padding:6px 10px; font-size:14px; border-radius:10px; margin-left:8px;
  background:#0f1320; color:#f2f4f8; border:1px solid #202437;
}
@media (max-width:480px){
  .bgm select{ font-size:13px; padding:6px 8px; }
}

/* ===== å…¨ç«™èƒŒæ™¯åœ–ï¼šä½¿ç”¨åŸåœ–ã€ä¸é™äº®åº¦ ===== */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background: url("assets/images/bg.webp") center/cover no-repeat fixed;
  opacity: 1;         /* åŸåœ–äº®åº¦ */
  filter: none;       /* å–æ¶ˆé£½å’Œ/äº®åº¦èª¿æ•´ */
  z-index:-1;
}

/* ===== å¯æ‘ºç–Š fieldsetï¼ˆAccordionï¼‰ ===== */
fieldset.fold{ overflow:hidden; padding:0; }
fieldset.fold > legend{
  display:flex; align-items:center; gap:8px;
  padding:12px; margin:0; cursor:pointer; user-select:none;
  border-bottom:1px solid #1f2435;
}
fieldset.fold > legend .legend-text{ flex:1; color:#d6daea; font-weight:600; }
fieldset.fold > legend .caret{
  width:10px; height:10px; transform:rotate(0deg);
  border-right:2px solid #cfd3e6; border-bottom:2px solid #cfd3e6;
  margin-left:6px; transition:transform .18s ease;
}
fieldset.fold[aria-expanded="true"] > legend .caret{ transform:rotate(45deg); }
fieldset.fold[aria-expanded="false"] > legend .caret{ transform:rotate(-135deg); }

/* æ±‚å•å°è±¡æŠ˜ç–Šå€ï¼šéŠ€ç™½éœ§å…‰åŠé€æ˜ï¼ˆæ›´é€äº®ï¼‰ */
.fold-content {
  padding: 10px 12px 12px;
  display: grid;
  gap: 12px;
  max-height: 0;
  overflow: hidden;
  transition: max-height .22s ease;

  background: rgba(255, 255, 255, 0.04); /* ğŸŒ«ï¸ å†é€æ˜ä¸€ç´šï¼ˆåŸ0.18â†’0.04ï¼‰ */
  -webkit-backdrop-filter: blur(9px) saturate(150%);
  backdrop-filter: blur(9px) saturate(150%);
  border-top: 1px solid rgba(255, 255, 255, 0.25);
  border-bottom: 1px solid rgba(255, 255, 255, 0.12);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1); /* æ·¡æ·¡é™°å½±å¢åŠ å±¤æ¬¡ */
}
fieldset.fold[aria-expanded="true"] > .fold-content {
  max-height: 800px;
}

@media (max-width:480px),(max-height:740px){
  fieldset.fold > legend{ padding:10px; }
  .fold-content{ padding:8px 10px 10px; gap:10px; }
}

/* ===== æ¡®ä¸‹æ–¹åç¨±ï¼ˆæ›´äº®ã€æ›´å¤§ã€æ›´é€ï¼‰ ===== */
.cup .label {
  font-size: 28px;                  /* ğŸ”¸å­—é«”æ”¾å¤§ï¼ˆåŸ24â†’28ï¼‰ */
  font-weight: 700;                 /* ğŸ”¸ç¨å¾®åŠ ç²—ï¼Œå±¤æ¬¡æ›´æ˜é¡¯ */
  color: #f8faff;
  text-shadow: 0 2px 4px rgba(0,0,0,0.45);
  background: rgba(0, 0, 0, 0.2);  /* ğŸ”¸é€æ˜åº¦æ¸›å°‘ï¼ˆåŸ0.5â†’0.2ï¼‰ */
  padding: 8px 14px;                /* ğŸ”¸å¤šä¸€é»ç•™ç™½ï¼Œæ¯”ä¾‹æ›´å”èª¿ */
  border-radius: 12px;
  display: inline-block;
  margin-top: 1.4em;
  margin-bottom: 2.6em;
  letter-spacing: 0.5px;            /* ğŸ”¸å¾®é–‹å­—è·ï¼Œè¦–è¦ºæ›´ç©©å®š */
}

/* æ‰‹æ©Ÿç‰ˆå¾®èª¿ */
@media (max-width:480px){
  .cup .label {
    font-size: 20px;                /* ğŸ”¸åŸ16â†’20ï¼Œä»å¯è®€ */
    background: rgba(0, 0, 0, 0.2); /* ğŸ”¸é€æ˜åº¦åŒæ¨£æ›´é€ */
    padding: 5px 9px;
    margin-top: 1.2em;
    margin-bottom: 2em;
  }
}

/* éš±è—å·¦ä¸‹æ–¹å¸¸é§èªªæ˜ï¼ˆå¦‚æ¡®çµæœé‡è¤‡é¡¯ç¤ºé‚£ä¸‰è¡Œï¼‰ */
#resLines > div:not(.small){ display:none; }

/* åªåœ¨çµæœé å›ºå®šå½©è›‹æ¢ï¼ˆé è¨­é€æ˜ï¼Œäº¤ç”± .show æ·¡å…¥ï¼‰ */
body.is-result #resLines .small{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:calc(72px + 12px);
  width:min(92vw,680px);
  z-index:15;
  text-align:left; font-size:14px; color:#f6f8ff;
  background:rgba(0,0,0,.55); border-radius:12px; padding:8px 12px;
  box-shadow:0 6px 24px rgba(0,0,0,.25);
}
@media (max-width:480px){
  body.is-result #resLines .small{
    bottom:calc(64px + 10px); width:94vw; font-size:13.5px;
  }
}
/* æ·¡å…¥æ§åˆ¶ï¼šé è¨­ 0ï¼Œ.show â†’ 1 */
#resLines .small{ opacity:0; transition:opacity .2s ease; }
#resLines .small.show{ opacity:1; }
  /* çµæœé  badge å­—ç´šï¼ˆæœ€çµ‚ç‰ˆæœ¬ï¼Œè«‹æ”¾åœ¨æª”æ¡ˆæœ€å¾Œï¼‰ */
#page-result .badge{
  font-size: 22px;
  padding: .35rem .75rem;
  font-weight: 700;
  letter-spacing: .4px;
  line-height: 1.1;
}
@media (max-width:480px){
  #page-result .badge{
    font-size: 18px;           /* æ‰‹æ©Ÿé©ä¸­ï¼Œä¸æœƒå¤ªå¤§å¡ç‰ˆé¢ */
    padding: .3rem .6rem;
  }
}
</style>

</head>
<body>
  <header>
    <h1 id="appTitle">è·‹æ¡®å•¦ï¼(PoaÌh-poe--lah!)</h1>
    <div class="lang">
      <label class="sr-only" for="langSel">èªè¨€</label>
      <select id="langSel" aria-label="èªè¨€">
        <option value="tl">å°èª</option>
        <option value="en">English</option>
        <option value="zh">è¯èª</option>
      </select>
    </div>
    <div class="bgm">
  <label class="sr-only" for="bgmSel">èƒŒæ™¯éŸ³æ¨‚</label>
    <select id="bgmSel" aria-label="èƒŒæ™¯éŸ³æ¨‚">
      <option value="bg_01" selected>è–æ¨‚ã®éŸ³</option>
      <option value="bg_02">é¢¨éˆ´ã®éŸ³</option>
      <option value="bg_03">æµ·æ´‹ã®éŸ³</option>
      <option value="bg_04">è‡ªç„¶ã®éŸ³</option>
    </select>
  </div>
  </header>
  <main>
    <!-- ===== Step 1. è¨­å®šé  ===== -->
    <section id="page-setup" aria-labelledby="setupTitle">
      <h2 id="setupTitle" class="sr-only">è¨­å®š</h2>
      <div class="row" id="setupForm">
        <fieldset>
          <legend data-i="askWhoLegend">æ±‚å•å°è±¡</legend>
          <div class="row">
            <label><input type="radio" name="who" value="god" checked> <span data-i="whoGod">æŸå°Šç¥æ˜</span></label>
            <input id="whoName" type="text" placeholder="åª½ç¥–ï¼é—œè–å¸å›ï¼è€¶ç©Œâ€¦" aria-describedby="whoHelp" />
            <div id="whoHelp" class="small" data-i="whoHelp">è¼¸å…¥ç¥æ˜ç¨±è™Ÿï¼Œæˆ–æ”¹é¸å…¶ä»–å°è±¡</div>
            <label><input type="radio" name="who" value="ancestor"> <span data-i="whoAnc">æŸä½ç¥–å…ˆï¼ˆå«éä¸–è¦ªäººï¼‰</span></label>
            <input id="ancName" type="text" placeholder="é˜¿å…¬ï¼é˜¿å¬¤ï¼é˜¿ç¥–â€¦" />
            <label><input type="radio" name="who" value="universe"> <span data-i="whoUni">å‘å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡æ±‚å•</span></label>
          </div>
        </fieldset>
        <label>
          <span data-i="yourName">æ±‚å•è€…å§“åï¼æš±ç¨±</span>
          <input id="player" type="text" placeholder="è¼¸å…¥ä½ çš„åå­—ï¼æš±ç¨±" />
        </label>
        <label>
          <span data-i="wish">æ±‚å•äº‹é …</span>
          <textarea id="wish"></textarea>
        </label>

        <fieldset>
          <legend data-i="cupLegend">é¸æ“‡æ¡®ã®æ¨£å¼</legend>
          <div id="cupList" class="cards" role="listbox" aria-label="æ¯æ¨£å¼"></div>
          <div class="small" data-i="cupHint">ğŸ””å°æé†’ï¼šä¸åŒæ¨£å¼åªæ˜¯å¤–è§€ï¼Œéˆé©—åº¦ç„¡å·®å–”ï½</div>
        </fieldset>
      </div>
    </section>

    <!-- ===== Step 2. ç¥ˆç¦±é  ===== -->
    <section id="page-pray" hidden aria-labelledby="prayTitle" class="center">
      <div style="width:100%">
        <h2 id="prayTitle" data-i="prayTitle">å…ˆèª å¿ƒç¥ˆç¦±ï¼Œå†è·‹æ¡®</h2>
        <p class="prayer" id="prayText"></p>
        <div class="dice">
          <div class="cup float" id="previewL"></div>
          <div class="cup float" id="previewR"></div>
        </div>
      </div>
    </section>

    <!-- ===== Step 3. çµæœé  ===== -->
    <section id="page-result" hidden aria-labelledby="resTitle">
      <h2 id="resTitle" data-i="resTitle">æŒ‡ç¤ºçµæœ</h2>
      <div class="dice">
        <div class="cup" id="resL"></div>
        <div class="cup" id="resR"></div>
      </div>
      <div class="result">
        <div><span class="badge" id="badge"></span></div>
        <div id="resLines"></div>
      </div>
    </section>
  </main>

  <div class="toolbar" role="group" aria-label="æ“ä½œ">
    <button class="btn ghost" id="btnBack" data-i="back">å›è¨­å®š</button>
    <button class="btn" id="btnNext" data-i="next">ä¸‹ä¸€æ­¥</button>
    <button class="btn primary" id="btnToss" data-i="toss" hidden>è·‹æ¡® / poaÌh-poe</button>
    <button class="btn" id="btnAgain" data-i="again" hidden>å†è·‹ä¸€æ“º</button>
    <button class="btn ghost" id="btnMute">èƒŒæ™¯éŸ³æ•ˆ ğŸ”ˆ</button>
  </div>

  <template id="tpl-line"><div class="small"></div></template>

  <!-- ä¸»é‚è¼¯ï¼šä½¿ç”¨ ES Modulesï¼Œç›´æ¥ import CUPS -->
  <script type="module">
    import { CUPS as REG_CUPS } from './js/cups/registry.js';

    // ===== helpers =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    if (!localStorage.getItem('lang')) {
      const sys = (navigator.language || 'zh').toLowerCase();
      if (sys.startsWith('en')) S.lang = 'en';
      else if (sys.startsWith('zh') || sys.startsWith('cmn')) S.lang = 'zh';
      else if (sys.includes('nan') || sys.includes('hak') || sys.includes('tw')) S.lang = 'tl'; // è¦–æƒ…æ³
      localStorage.setItem('lang', S.lang);
    }

    // ===== i18n =====
    const I18N = {
      zh: {
        askWhoLegend:"æ±‚å•å°è±¡", whoGod:"æŸå°Šç¥æ˜", whoAnc:"æŸä½ç¥–å…ˆï¼ˆå«éä¸–è¦ªäººï¼‰", whoUni:"å‘å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡æ±‚å•",
        whoHelp:"è¼¸å…¥ç¥æ˜ç¨±è™Ÿï¼Œæˆ–æ”¹é¸å…¶ä»–å°è±¡", yourName:"æ±‚å•è€…å§“åï¼æš±ç¨±", wish:"æ±‚å•äº‹é …",
        cupLegend:"é¸æ“‡æ¡®æ¨£å¼", cupHint:"å°æé†’ï¼šä¸åŒæ¨£å¼åªæ˜¯å¤–è§€ï¼Œæ©Ÿç‡ä¸€æ¨£å•¦ï½",
        prayTitle:"å…ˆèª å¿ƒç¥ˆç¦±ï¼Œå†æ“²ç­Š", resTitle:"æŒ‡ç¤ºçµæœ",
        back:"å›è¨­å®š", next:"ä¸‹ä¸€æ­¥", toss:"æ“²ç­Š", again:"å†æ“²ä¸€æ¬¡",
        ok:"è–æ¯ï¼šå¾—åˆ°æ‡‰å…ï¼Œå»åšå°±å°äº†ï¼",
        bad:"é™°æ¯ï¼šç¥æ˜èªªä¸è¡Œï¼Œæ›å€‹æ–¹æ³•å§ã€‚",
        meh:"ç¬‘æ¯ï¼šç¥æ˜ï¼å…ˆäººï¼ç¥ç§˜åŠ›é‡ç¬‘äº†ï¼Œå¯èƒ½é‚„æ²’æ—¨æ„ï¼Œæˆ–æ˜¯æ²’è½æ‡‚ä½ çš„æ„æ€ï¼Œè«‹å†å•ä¸€æ¬¡ã€‚",
        who:"æ±‚å•å°è±¡", you:"æ±‚å•è€…", topic:"äº‹é …",
        streak: {
          meh: 'â“â“â“ é€£çºŒä¸‰æ“ºã€Œç¬‘æ¯ã€ï¼Œå»ºè­°ï¼š<b>è‡ªå·±åšä¸»ï¼ğŸ˜†</b>',
          bad: 'ğŸš«ğŸš«ğŸš« é€£çºŒä¸‰æ“ºã€Œé™°æ¯ã€ï¼Œå»ºè­°ï¼š<b>çœŸçš„ä¸è¡Œå–”ï¼âŒ</b>',
          ok:  'ğŸ‰ğŸ‰ğŸ‰ é€£çºŒä¸‰æ“ºã€Œè–æ¯ã€ï¼Œå»ºè­°ï¼š<b>å»åšå°±å°ï¼ğŸ˜</b>'
        }
      },
      tl: {
        askWhoLegend:"æ±‚å•å°è±¡", whoGod:"æŸå°Šç¥æ˜", whoAnc:"æŸmÃ­ç¥–å…ˆï¼ˆåŒ…æ‹¬éèº«è¦ªäººï¼‰", whoUni:"Ç¸gå®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡æ±‚å•",
        whoHelp:"è¼¸å…¥ç¥æ˜ç¨±è™Ÿï¼Œæˆ–æ”¹é¸å…¶ä»–å°è±¡", yourName:"æ±‚å•è€…å§“åï¼æš±ç¨±", wish:"æ±‚å•äº‹é …",
        cupLegend:"é¸æ¡®æ¬¾å¼", cupHint:"æç¤ºï¼šæ¬¾å¼ä»æ¬¾ï¼Œæ©Ÿç‡è¢‚è®Šï½",
        prayTitle:"èª å¿ƒç¥ˆæ±‚äº†å¾Œï¼Œæ¤è½å»è·‹æ¡®", resTitle:"æŒ‡ç¤ºçµæœ",
        back:"å€’è½‰--å»", next:"å¾Œä¸€æ­¥", toss:"è·‹æ¡® / poaÌh-poe", again:"é–£è·‹ä¸€æ“º",
        ok:"ç¥æ¡®ï¼ˆsÃ®n-poe / siÅ«â¿-poeï¼‰ï¼šå¾—è‘—æ‡‰å…ï¼Œä½ Ãªç¥ˆæ±‚æœƒå¯¦ç¾ï¼",
        bad:"é™°æ¡®ï¼ˆim-poe / bÃ´-poeï¼‰ï¼šæ¯‹é€šå–”ï¼Œæ›ä¸€æ¬¾åšæ³•ã€‚",
        meh:"ç¬‘æ¡®ï¼ˆchhiÃ²-poeï¼‰ï¼šç¥æ˜ï¼å…ˆäººï¼ç¥ç§˜åŠ›é‡ç¬‘ç¬‘lehï¼Œå¯èƒ½çŒ¶æœªæœ‰æ—¨æ„ï¼ŒæŠ‘æ˜¯è½ç„¡ä½ Ãªæ„æ€ã€‚",
        who:"æ±‚å•å°è±¡", you:"ç¥ˆæ±‚è€…", topic:"æ±‚å•¥ä»£èªŒ",
        streak: {
          meh: 'â“â“â“ é€£çºŒä¸‰æ“ºã€Œç¬‘æ¡®ã€ï¼Œå»ºè­°ï¼š<b>å®¶å·±æ±ºå®šå•¦ï¼ğŸ˜†</b>',
          bad: 'ğŸš«ğŸš«ğŸš« é€£çºŒä¸‰æ“ºã€Œé™°æ¡®ã€ï¼Œå»ºè­°ï¼š<b>çœŸæ­£æ¯‹é€šå–”ï¼âŒ</b>',
          ok:  'ğŸ‰ğŸ‰ğŸ‰ é€£çºŒä¸‰æ“ºã€Œç¥æ¡®ã€ï¼Œå»ºè­°ï¼š<b>åšå°±è‘—å•¦ï¼ğŸ˜</b>'
        }
      },
      en: {
        title: "PoaÌh-poe--lah!(Funny Decision Maker)",
        askWhoLegend:"Who to ask?",
        whoGod:"A deity",
        whoAnc:"An ancestor (incl. passed relatives)",
        whoUni:"The universe / unseen forces",
        whoHelp:"Enter a deityâ€™s title, or pick a different target.",
        yourName:"Your name / nickname",
        wish:"Question / intention",
        cupLegend:"Choose your poe style",
        cupHint:"Note: all styles are cosmetic; odds are identical.",
        prayTitle:"Say a sincere prayer, then toss",
        resTitle:"Response",
        back:"Back",
        next:"Next",
        toss:"Toss / poaÌh-poe",
        again:"Toss again",
        // outcomes
        ok:"ShÃ¨ng-poe (OK): Approved â€” go for it!",
        bad:"Im-poe (No): Not approved â€” try another way.",
        meh:"ChhiÃ²-poe (Hmm): Not clear yet â€” ask once more.",
        // labels
        who:"Target",
        you:"Player",
        topic:"Topic",
        streak: {
          meh: 'â“â“â“ Three straight â€œChhiÃ²-poe (Hmm)â€. Hint: <b>Make the call yourself!</b> ğŸ˜†',
          bad: 'ğŸš«ğŸš«ğŸš« Three straight â€œIm-poe (No)â€. Hint: <b>Probably a hard no.</b> âŒ',
          ok:  'ğŸ‰ğŸ‰ğŸ‰ Three straight â€œShÃ¨ng-poe (OK)â€. Hint: <b>Go for it!</b> ğŸ˜'
        }
      }
    };

    // ===== state =====
    const CUPS = REG_CUPS;
    if (!CUPS || !CUPS.length) {
      console.error('CUPS è¼‰å…¥å¤±æ•—ï¼šè«‹æª¢æŸ¥ js/cups/manifest.js / registry.js');
    }
    const S = {
      lang: localStorage.getItem('lang') || 'zh',
      cup: CUPS?.[0]?.id || '',
      whoType: 'god',
    };

    // ===== UI i18n =====
    const langSel = $('#langSel');
    function applyI18N(){
      const t = I18N[S.lang] || I18N.zh;
      $$('[data-i]').forEach(el=>{ const k = el.getAttribute('data-i'); if(t[k]) el.textContent = t[k]; });
      document.title = t.title || 'è·‹æ¡®å•¦ï¼(PoaÌh-poe--lah)';
      const h1 = document.getElementById('appTitle');
      if (h1) h1.textContent = t.title || 'è·‹æ¡®å•¦ï¼(PoaÌh-poe--lah)';
    }
    langSel.value = S.lang; applyI18N();
    langSel.addEventListener('change', () => {
      S.lang = langSel.value;
      localStorage.setItem('lang', S.lang);

      applyI18N();                 // æ› UI æ–‡æ¡ˆï¼ˆæŒ‰éˆ•/æ¨™é¡Œç­‰ï¼‰
      rebuildCupList();            // é‡å»ºæ¡®å¡ç‰‡ï¼ˆåç¨±è·Ÿè‘—æ›èªè¨€ï¼‰
      syncPreviewsAndResult();     // ç¥ˆç¦±é è¦½ & çµæœåœ–ï¼ˆå« altï¼‰åŒæ­¥
      buildPrayerText();           // ç¥ˆç¦±æ–‡æ›èªè¨€
      buildResultLines(lastOutcome); // çµæœå€æ–‡æ¡ˆæ›èªè¨€
    });

    // ===== SFX =====
    const SFX = {
      toss: 'assets/sounds/toss.ogg',
      ok:   'assets/sounds/ok.ogg',
      bad:  'assets/sounds/bad.ogg',
      meh:  'assets/sounds/meh.ogg',
      select: 'assets/sounds/select.ogg'
    };
    function playSfx(name){
      const src = SFX[name]; if(!src) return;
      // ä¾ä¸åŒéŸ³æ•ˆçµ¦ä¸åŒ duck æ™‚é•·ï¼ˆå¯å†å¾®èª¿ï¼‰
      const duckMs = (name === 'toss') ? 900 : 600;
      duckBgm(0.22, duckMs);   // âœ… æ’­æ”¾ SFX å‰å…ˆå£“ä½ BGM

      try { new Audio(src).play().catch(()=>{}); } catch(e){}
    }

    // ===== BGM duck/unduckï¼ˆæŠ•æ“²èˆ‡çµæœæ™‚å£“ä½éŸ³é‡ï¼Œå®Œäº†å†æ‹‰å›ï¼‰ =====
    let _duckTimer = null;
    let _bgmPrevVol = 0.5; // ä½ çš„é è¨­éŸ³é‡ï¼ˆè¦‹ playBgm è£¡ï¼‰

    function duckBgm(toVol = 0.22, holdMs = 800){
      if (!bgmAudio) return;
      // è¨˜ä½ç•¶å‰éŸ³é‡ï¼Œåªåœ¨æœª duck æ™‚è¨˜
      if (_duckTimer === null) _bgmPrevVol = bgmAudio.volume;
      bgmAudio.volume = Math.max(0, Math.min(1, toVol));
      clearTimeout(_duckTimer);
      _duckTimer = setTimeout(()=>{
        if (bgmAudio) bgmAudio.volume = _bgmPrevVol;
        _duckTimer = null;
      }, holdMs);
    }

    // ===== èƒŒæ™¯éŸ³æ¨‚ï¼ˆé¦–é å¯åˆ‡æ›ï¼‰ =====
    let bgmAudio = null;
    let bgmMuted = false;
    let currentBgmId = null;

    function playBgm(id){
      if (bgmAudio && currentBgmId === id && !bgmAudio.paused) return;
      stopBgm({fadeOut:false});
      if (!id) return;
      currentBgmId = id;

      const src = `assets/sounds/${id}.ogg`;
      bgmAudio = new Audio(src);
      bgmAudio.loop = true;
      bgmAudio.muted = bgmMuted;
      bgmAudio.volume = 0.5;
      bgmAudio.play().catch(()=>{});
    }

    function stopBgm({fadeOut=true} = {}){
      if (!bgmAudio) return;
      if (!fadeOut){
        bgmAudio.pause();
        bgmAudio = null;
        currentBgmId = null;
        return;
      }
      const a = bgmAudio;
      const fade = setInterval(()=>{
        if (!a) { clearInterval(fade); return; }
        a.volume = Math.max(0, a.volume - 0.05);
        if (a.volume <= 0.01){
          clearInterval(fade);
          a.pause();
          if (bgmAudio === a) {
            bgmAudio = null;
            currentBgmId = null;
          }
        }
      }, 100);
    }

    // Mute éˆ•
    $('#btnMute').addEventListener('click', ()=>{
      bgmMuted = !bgmMuted;
      if (bgmAudio) bgmAudio.muted = bgmMuted;
      $('#btnMute').textContent = bgmMuted ? 'éŸ³æ¨‚é—œé–‰ ğŸ”‡' : 'èƒŒæ™¯éŸ³æ¨‚ ğŸ”ˆ';
    });

    // ä¸‹æ‹‰åˆ‡æ›
    const bgmSel = $('#bgmSel');
    bgmSel.addEventListener('change', ()=>{
      const id = bgmSel.value;
      playBgm(id);
    });

    // åˆå§‹åŒ–ï¼šè‡ªå‹•æ’­æ”¾é è¨­ bg_01ï¼ˆå¾…ä½¿ç”¨è€…äº’å‹•å¾Œï¼‰
    document.body.addEventListener('click', ()=>{
      if (!bgmAudio) playBgm('bg_01');
    }, { once: true });

    // ===== setup helpers =====
    function getRadio(name){ return (document.querySelector(`input[name="${name}"]:checked`)||{}).value; }
    function readSetup(){
      const whoType = getRadio('who');
      const whoName = (whoType==='god')? $('#whoName').value.trim() : (whoType==='ancestor')? $('#ancName').value.trim() : '';
      return {
        whoType, whoName,
        player: $('#player').value.trim() || 'ç©å®¶',
        wish:   $('#wish').value.trim() || 'ï¼ˆæœªè¼¸å…¥ï¼‰',
        cup:    S.cup
      }
    }
    function buildPrayerText(){
      const t = I18N[S.lang]; const s = readSetup();
      const who =
        s.whoType==='god'      ? (s.whoName || (S.lang==='tl'?'æŸå°Šç¥æ˜': S.lang==='en'?'a deity':'æŸå°Šç¥æ˜')) :
        s.whoType==='ancestor' ? (s.whoName || (S.lang==='tl'?'æŸä½ç¥–å…ˆ': S.lang==='en'?'an ancestor':'æŸmÃ­ç¥–å…ˆ')) :
                                  (S.lang==='tl'?'å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡' : S.lang==='en'?'the universe and unseen forces':'å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡');

      let line;
      if (S.lang==='tl'){
        line = `ğŸ™${who}ğŸ™ï¼Œä¿¡å¾’${s.player}è™”èª ç¥ˆæ±‚ï¼Œç‚ºè‘—ã€Œ${s.wish}ã€è«‹ç¤ºæŒ‡æ•™ã€‚`;
      } else if (S.lang==='en'){
        line = `Dear ${who}, I (${s.player}) sincerely ask for guidance regarding: â€œ${s.wish}â€.`;
      } else { // zh
        line = `${who}åœ¨ä¸Šï¼Œä¿¡å¾’ï¼ˆ${s.player}ï¼‰èª å¿ƒç¥ˆæ±‚ï¼Œç‚ºã€Œ${s.wish}ã€è«‹ç¤ºæŒ‡å¼•ã€‚`;
      }
      $('#prayText').textContent = line;
    }

    function cupLabel(c){
      if (c && typeof c.name === 'object') {
        return c.name[S.lang] || c.name.tl || c.name.en || c.name.zh || Object.values(c.name)[0];
      }
      return c?.name || '';
    }

    // ===== build cup list =====
    const cupList = $('#cupList');

    function rebuildCupList(){
      cupList.innerHTML = '';
      CUPS.forEach(c=>{
        const btn = document.createElement('button');
        btn.className='card';
        btn.type='button';
        btn.setAttribute('role','option');
        btn.setAttribute('aria-pressed', c.id===S.cup?'true':'false');
        btn.dataset.id = c.id;
        btn.innerHTML = `<div class="thumb">${c.render('yang')}</div><span class="label">${cupLabel(c)}</span>`;
        btn.addEventListener('click',()=>{
          playSfx('select'); // ğŸ”Š é»é¸æç¤ºéŸ³
          S.cup = c.id; $$('.card').forEach(x=>x.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true');
          const cup = CUPS.find(x=>x.id===S.cup)||CUPS[0];
          $('#previewL').innerHTML = cup.render('yang');
          $('#previewR').innerHTML = cup.render('yin');
        });
        cupList.appendChild(btn);
      });
    }
    // ===== èªè¨€åˆ‡æ›æ™‚ï¼Œé è¦½/çµæœä¹ŸåŒæ­¥é‡ç•«ï¼ˆå« altï¼‰=====
    function syncPreviewsAndResult() {
      const cup = CUPS.find(c => c.id === S.cup) || CUPS[0];

      // ç¥ˆç¦±é å…©é¡†é è¦½
      const pl = document.getElementById('previewL');
      const pr = document.getElementById('previewR');
      if (pl && pr && cup) {
        pl.innerHTML = cup.render('yang');
        pr.innerHTML = cup.render('yin');
      }

      // è‹¥ç›®å‰åœ¨çµæœé ï¼Œä¾æœ€å¾Œä¸€æ¬¡ outcome é‡ç•«å·¦å³æ¡®
      const resSection = document.getElementById('page-result');
      if (resSection && resSection.hidden === false && lastOutcome && cup) {
        const l = document.getElementById('resL');
        const r = document.getElementById('resR');
        if (l) l.innerHTML = cup.render(lastOutcome.L);
        if (r) r.innerHTML = cup.render(lastOutcome.R);
      }
    }

  // æŠ•æ“² â†’ å…ˆå½ˆè·³(.cup) â†’ ç™¼å…‰+å·¦å³æ“ºå‹• â†’ è¼•æ™ƒæ”¶å°¾
  function applyTossAndShake(el, type){
    const cup = el.closest('.cup') || el;

    // å…ˆæ¸…ä¹¾æ·¨ï¼Œé¿å…æ®˜ç•™å°è‡´é‡æ’­
    [el, cup].forEach(x => x && x.classList.remove('toss','bounce','sway','shake','glow'));
    void el.offsetWidth; // reflow

    const TOSS_MS   = 900;  // .toss 0.9s
    const BOUNCE_MS = 800;  // .bounceStrong 0.8s
    const SWAY_MS   = 1100; // .sway 1.1s
    const SHAKE_MS  = 600;  // .shake 0.6s

    // 1) æŠ•æ“²
    el.classList.add('toss');

    setTimeout(() => {
      el.classList.remove('toss');

      // 2) å…ˆå½ˆï¼ˆåªå¥—åœ¨ .cupï¼‰
      cup.classList.add('bounce');

      setTimeout(() => {
        // ğŸ‘‰ å½ˆè·³çµæŸç«‹åˆ»æ‹”æ‰ï¼Œé¿å…ä¹‹å¾Œåˆè¢«è§¸ç™¼
        cup.classList.remove('bounce');

        // 3) ç™¼å…‰ + å·¦å³æ“º
        if (type) el.dataset.outcome = type; // ok / bad / meh
        el.classList.add('glow','sway');

        setTimeout(() => {
          // 4) è¼•æ™ƒæ”¶å°¾
          el.classList.remove('sway');
          el.classList.add('shake');

          setTimeout(() => {
            // 5) æ¸…ç†
            el.classList.remove('shake','glow');
            delete el.dataset.outcome;
          }, SHAKE_MS);
        }, SWAY_MS);
      }, BOUNCE_MS);
    }, TOSS_MS);
  }

    // ===== navigation =====
    const PAGES = ['setup','pray','result'];
    function show(page){
      PAGES.forEach(p=>{ const el = $('#page-'+p); if(el) el.hidden = (p!==page); });
      $('#btnBack').hidden = (page==='setup');
      $('#btnNext').hidden = (page!=='setup');
      $('#btnToss').hidden = (page!=='pray');
      $('#btnAgain').hidden = (page!=='result');
        // âœ… åªæœ‰çµæœé æ™‚å•Ÿç”¨ç·Šæ¹Šå¸ƒå±€
      document.body.classList.toggle('is-result', page === 'result');
    }

    // ===== toss logic =====
    let lastOutcome = null; // {L:'yin|yang', R:'yin|yang', type:'ok|bad|meh'}
    function toss(){
      playSfx('toss');
      const sides = ['yin','yang'];
      const L = sides[Math.random()<0.5?0:1];
      const R = sides[Math.random()<0.5?0:1];
      let type;
      if((L==='yin' && R==='yang') || (L==='yang' && R==='yin')) type='ok';
      else if(L==='yang' && R==='yang') type='bad';
      else type='meh';
      lastOutcome = {L,R,type};

      const cup = CUPS.find(c=>c.id===S.cup) || CUPS[0];
      const l = $('#resL'), r = $('#resR');
      l.innerHTML = cup.render(lastOutcome.L); applyTossAndShake(l, type); setTimeout(()=>l.classList.remove('toss'), 950);
      r.innerHTML = cup.render(lastOutcome.R); applyTossAndShake(r, type); setTimeout(()=>r.classList.remove('toss'), 950);

      const t = I18N[S.lang];
      const badge = $('#badge');
      badge.className = 'badge ' + (lastOutcome.type==='ok'?'ok': lastOutcome.type==='bad'?'bad':'meh');
      badge.textContent = lastOutcome.type==='ok'? t.ok : lastOutcome.type==='bad'? t.bad : t.meh;

      buildResultLines(lastOutcome);
      setTimeout(()=> playSfx(type), 120); // æŠ•æ“²è²å¾Œè£œçµæœè²
    }

    // ===== result lines =====
    function buildResultLines(outcome){
      const t = I18N[S.lang]; const s = readSetup(); if(!outcome) return;
      const who = s.whoType==='god' ? (s.whoName|| (S.lang==='tl'?'æŸä½ç¥æ˜':'æŸä½ç¥æ˜'))
                : s.whoType==='ancestor'? (s.whoName|| (S.lang==='tl'?'æŸä½ç¥–å…ˆ':'æŸä½ç¥–å…ˆ'))
                : (S.lang==='tl'?'å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡':'å®‡å®™å¤©åœ°å†¥å†¥ä¹‹ä¸­åŠ›é‡');
      const box = $('#resLines'); box.innerHTML='';
      const add = (label, text)=>{ const d = document.importNode($('#tpl-line').content,true); d.querySelector('div').innerHTML = `<b>${label}ï¼š</b> ${escapeHtml(text)}`; box.appendChild(d); };
      add(t.who, who);
      add(t.you, s.player);
      add(t.topic, s.wish);
      // å½©è›‹ï¼šåµæ¸¬ä¸‰é€£ç™¼
      historyPush(outcome.type);
      const tStreak = I18N[S.lang]?.streak;

      const eggBox = document.createElement('div');
      eggBox.className = 'small';

      if (checkStreak(['ok','ok','ok']) && tStreak?.ok) {
        eggBox.innerHTML = tStreak.ok;
        box.appendChild(eggBox);
      } else if (checkStreak(['bad','bad','bad']) && tStreak?.bad) {
        eggBox.innerHTML = tStreak.bad;
        box.appendChild(eggBox);
      } else if (checkStreak(['meh','meh','meh']) && tStreak?.meh) {
        eggBox.innerHTML = tStreak.meh;
        box.appendChild(eggBox);
      }

      // === æ·¡å…¥é¡¯ç¤ºå½©è›‹ ===
      if (box.querySelector('.small')) {
        const egg = box.querySelector('.small:last-child');
        requestAnimationFrame(() => egg.classList.add('show'));
      }
    }

    // ===== misc utils =====
    const hist = [];
    function historyPush(type){ hist.push(type); if(hist.length>9) hist.shift(); }
    function checkStreak(seq){ if(hist.length < seq.length) return false; const n = seq.length; for(let i=0;i<=hist.length-n;i++){ if(seq.every((v,k)=>hist[i+k]===v)) return true; } return false; }
    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

    // ===== buttons =====
    $('#btnNext').addEventListener('click',()=>{
      buildPrayerText();
      const cup = CUPS.find(c=>c.id===S.cup)||CUPS[0];
      $('#previewL').innerHTML = cup.render('yang');
      $('#previewR').innerHTML = cup.render('yin');
      show('pray');

     // âœ… é€²ç¥ˆç¦±é å¾Œä¾é¸é …æ’­æ”¾ BGM
     const bgmId = document.querySelector('input[name="bgm"]:checked')?.value;
     if (bgmId) playBgm(bgmId, {fadeIn:true});
   });
    $('#btnBack').addEventListener('click',()=>{ show('setup'); });
    $('#btnToss').addEventListener('click', ()=>{
      // æ¸…æ‰ç¥ˆç¦±é çš„æµ®å‹•é è¦½ï¼Œé¿å…æ®˜å½±/èª¤æœƒ
      $('#previewL').innerHTML = '';
      $('#previewR').innerHTML = '';
      show('result');
      toss();
      // æ²åˆ°æœ€ä¸Šé¢ï¼Œç¢ºä¿åªçœ‹å¾—åˆ°çµæœé 
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    $('#btnAgain').addEventListener('click', ()=>{
      toss();                 // ç›´æ¥é‡æ“²
      show('result');         // ä¿æŒåœ¨çµæœé 
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ===== å¯æ‘ºç–Š fieldsetï¼ˆè‡ªå‹•å¥—ç”¨åˆ°è¨­å®šé ï¼‰ =====
  function makeFieldsetFoldable(fs, {open=false, storageKey} = {}){
    if (!fs || fs.classList.contains('folded-ready')) return;
    fs.classList.add('fold','folded-ready');

    // è®€å–å„²å­˜ç‹€æ…‹ï¼ˆå„ªå…ˆæ–¼ open åƒæ•¸ï¼‰
    const key = storageKey || `fold:${fs.id || fs.querySelector('legend')?.textContent || 'unnamed'}`;
    const saved = localStorage.getItem(key);
    const shouldOpen = saved ? (saved === '1') : !!open;

    // å–å‡º legendï¼Œå…¶é¤˜å­©å­åŒ…æˆå…§å®¹å€
    const legend = fs.querySelector('legend') || fs.insertAdjacentElement('afterbegin', document.createElement('legend'));
    const content = document.createElement('div');
    content.className = 'fold-content';
    while (legend.nextSibling) content.appendChild(legend.nextSibling); // å…¨éƒ¨ç§»å…¥
    fs.appendChild(content);

    // é‡æ–°çµ„ legendï¼šæ–‡å­— + caret
    const textSpan = document.createElement('span');
    textSpan.className = 'legend-text';
    textSpan.textContent = legend.textContent.trim() || 'å…§å®¹';
    legend.textContent = '';
    legend.appendChild(textSpan);

    const caret = document.createElement('i');
    caret.className = 'caret';
    legend.appendChild(caret);

    // å¯é»æ“Šåˆ‡æ›
    fs.setAttribute('aria-expanded', shouldOpen ? 'true':'false');
    if (shouldOpen){
      // å…ˆè®“å®ƒèƒ½å±•é–‹åˆ°åˆé©é«˜åº¦ï¼ˆå…ˆç®—å…§å®¹é«˜åº¦ï¼‰
      requestAnimationFrame(()=>{ fs.setAttribute('aria-expanded','true'); });
    }

    legend.addEventListener('click', ()=>{
      const openNow = fs.getAttribute('aria-expanded') === 'true';
      fs.setAttribute('aria-expanded', openNow ? 'false' : 'true');
      localStorage.setItem(key, openNow ? '0' : '1');
    });
  }

  // æŠŠè¨­å®šé çš„ä¸‰å€‹å€å¡Šè®Šæˆå¯æ‘ºç–Š
  function setupAccordion(){
    // ä½ ç¾åœ¨çš„è¨­å®šé æœ‰ä¸‰å¡Šï¼šæ±‚å•å°è±¡ / åŸºæœ¬è³‡æ–™ / æ¡®æ¨£å¼
    // ä¾å¯¦éš› fieldset é †åºè‡ªå‹•å¥—ç”¨ï¼šç¬¬ 1 å¡Šå±•é–‹ï¼Œå…¶é¤˜æ”¶åˆ
    const sets = Array.from(document.querySelectorAll('#page-setup fieldset'));
    sets.forEach((fs, idx)=>{
      makeFieldsetFoldable(fs, { open: idx === 0, storageKey: `poah:fold:${idx}` });
    });
  }

    // ===== init =====
    rebuildCupList();
    setupAccordion();
    show('setup');
    bindBgmRadios();
    $$('input[name="who"]').forEach(r=>{
      r.addEventListener('change',()=>{
        const v = getRadio('who'); S.whoType=v;
        $('#whoName').disabled = v!=='god';
        $('#ancName').disabled = v!=='ancestor';
      });
    });
    $('#whoName').disabled=false; $('#ancName').disabled=true;

    // Keyboard: press Enter/Space to toss on pray page
    document.addEventListener('keydown',(e)=>{
      if(!$('#page-pray').hidden && (e.key==='Enter'||e.key===' ')){ e.preventDefault(); $('#btnToss').click(); }
    });
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    });
  }
  </script>
</body>
</html>
